<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdrawal Section & Guide</title>
    
    <!-- Firebase SDKs (Version 8.10.0) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --dark-bg: #2c3e50;
            --light-bg: #ffffff;
            --danger-color: #dc3545;
            --pending-color: #ffc107;
            --completed-color: #28a745;
            --shadow-deep: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        /* --- HEADER STYLES --- */
        header {
            background-color: var(--dark-bg);
            color: white;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.5em;
            margin: 0;
            text-align: left;
        }

        #profileIconButton {
            background: none;
            border: 2px solid white;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            transition: background-color 0.3s;
        }
        #profileIconButton:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        /* --- MAIN CONTAINER & ARTICLE STYLES --- */
        .container {
            width: 90%;
            max-width: 800px;
            margin: 40px auto;
            background-color: var(--light-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Article Styling */
        .article h2 {
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .article p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .article ul, .article ol {
            margin-left: 20px;
            padding-left: 0;
        }

        /* --- WITHDRAWAL SECTION STYLES (Hidden by default) --- */
        #withdrawalSection {
            display: none; /* Hidden until logged in */
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px dashed #ccc;
        }

        .balance-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* Withdrawal Buttons */
        .withdrawal-packages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .withdrawal-btn {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 10px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.9em;
        }
        .withdrawal-btn:hover {
            background-color: #e0e0e0;
        }
        .withdrawal-btn.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        /* Form and History styles remain the same */
        .form-group label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #withdrawalButton {
            background-color: var(--danger-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1.1em;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        
        .history-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }

        .status-pending { color: var(--pending-color); font-weight: bold; }
        .status-completed { color: var(--completed-color); font-weight: bold; }
        .status-rejected { color: var(--danger-color); font-weight: bold; }
        
        /* --- AUTH MODAL STYLES --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--light-bg);
            padding: 40px;
            border-radius: 12px;
            width: 90%; 
            max-width: 400px;
            box-shadow: var(--shadow-deep);
            position: relative;
            animation: modalopen 0.5s;
        }
        
        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
        }

        #authTitle {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .auth-form input {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .auth-form button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
        }

        .auth-toggle {
            margin-top: 20px;
            text-align: center;
        }
        
        .auth-toggle a {
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        #loginPrompt {
            text-align: center;
            padding: 20px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header>
        <h1>Coins Withdrawal Center</h1>
        <button id="profileIconButton" title="Login or View Profile">üë§</button>
    </header>

    <div class="container">
        
        <!-- Article/Guide Section (Visible by default) -->
        <div class="article">
            <h2 style="text-align: center; color: var(--danger-color);">Aasan Tareeqon Se Online Paise Kamaen: Mukammal Guide</h2>
            
            <p>Coins Withdrawal Center mein aapka khushamdeed! Yahan aap apni kamai hui coins ko haqeeqi raqam mein tabdeel kar sakte hain. **Naya Rate:** Ab **4 Coins** ke badle aapko **1 PKR** milega. Minimum withdrawal limit **1200 Coins** hai.</p>

            <div id="loginPrompt">
                Withdrawal Section dekhne aur istemal karne ke liye, barah-e-meherbani Profile Icon (üë§) par click karke Login/Signup karen.
            </div>

            <h2>1. Shuruat Kaise Karen: Sign Up Aur Login</h2>
            
            <p>Platform par shamil hona nihayat aasan hai:</p>
            
            <ul>
                <li><strong>Sign Up:</strong> Header mein maujood **Profile Icon (üë§)** par click karen. Modal khulne par 'Signup Karen' par click karke naya account banaen.</li>
                <li><strong>Login:</strong> Account banane ke baad, ya agar aapka account pehle se hai, to **Profile Icon (üë§)** par click karke apni credentials daal kar login karen.</li>
                <li><strong>Access:</strong> Login karte hi, yeh guide article chhip jayega aur aapko fori taur par Withdrawal Form aur History nazar aana shuru ho jayegi.</li>
            </ul>

            <h2>2. Coins Kamane Ke Aasan Tareeqe</h2>
            
            <p>Humari platform par coins kamana bahut mazedar aur seedha hai:</p>
            
            <ul>
                <li><strong>Video Watch Kar Ke:</strong> Mukhtalif brands aur creators ki videos dekhen. Har mukammal video dekhne par aapke account mein fori coins jama ho jayenge.</li>
                <li><strong>Like, Comment, Aur Share Kar Ke:</strong> Content ko like karen, achhe comments karen, aur social media par share karen. Har engagement ke badle aapko bonus coins milenge.</li>
            </ul>

            <h2>3. Bari Earning Ke Liye Bonus Tareeqe</h2>
            
            <p>Agar aap apni aamdani tez karna chahte hain, to yeh do tareeqe aapke liye sabse behtar hain:</p>
            
            <ul>
                <li><strong>App Download Aur Istemal:</strong> Humare partners ki taraf se di gayi apps ko download karen aur unhein kuch waqt ke liye istemal karen.</li>
                <li><strong>Products Kharid Kar:</strong> Humare platform ke zariye products kharidne par aapko bara cashback (coins ki shakal mein) milta hai.</li>
            </ul>

            <h2>4. Real-Time Withdrawal Ka Mukammal Guide</h2>
            
            <p>Coins kamane ke baad, unhein nikalwana (withdrawal) sabse aasan amal hai. Hum real-time withdrawal request processing faraham karte hain:</p>
            
            <ol>
                <li><strong>Minimum Limit:</strong> Withdrawal ke liye kam az kam <strong>1200 Coins</strong> zaroori hain (jo ke 300 PKR ke barabar hain).</li>
                <li><strong>Payment Methods:</strong> Aap EasyPaisa, JazzCash, ya Pakistani Banks ke zariye raqam nikalwa sakte hain.</li>
                <li><strong>Request Process:</strong> Login karne ke baad, Withdrawal Form mein miqdar chunein ya darj karen. Request submit karte hi, coins aapke balance se kaat liye jayenge.</li>
                <li><strong>PKR Calculation:</strong> Aapke coins ko 4 se divide karke PKR amount aapke account mein transfer kiya jayega.</li>
                <li><strong>Status Tracking:</strong> Aapki request 'Pending' status mein chali jayegi. Aap History section mein apni request ka status track kar sakte hain.</li>
            </ol>
            <p style="background-color:#f0f8ff; padding:10px; border-left:5px solid #007BFF; animation: fadeIn 2s;">
<strong>Owner Claim vs Real Risk Comparison</strong>
</p>

<p style="background-color:#e6ffe6; padding:10px; border-left:5px solid #28a745; animation: fadeIn 2s;">
<strong>Owner Claim:</strong><br>
1. Website 100% safe hai.<br>
2. Users easily paise earn kar sakte hain.<br>
3. Withdrawal process guaranteed aur instant hai.<br>
4. No risk, fully reliable platform.
</p>

<p style="background-color:#fff0f0; padding:10px; border-left:5px solid #dc3545; animation: fadeIn 2s;">
<strong>Real Risk (Independent Check):</strong><br>
1. ScamAdviser Score 71/100 ‚Äì moderate risk.<br>
2. Unrealistic earning claims ‚Äì get-rich-quick pattern.<br>
3. Limited verified user feedback ‚Äì withdrawal confirmation uncertain.<br>
4. New domain, owner info private ‚Äì transparency issue.<br>
5. Mostly UK-based service ‚Äì Pakistan support and payout uncertain.<br>
6. Heavy social media promotions ‚Äì overhyped, reliability questionable.
</p>

<p style="background-color:#fff8dc; padding:10px; border-left:5px solid #ffc107; animation: fadeIn 2s;">
<strong>Takeaway:</strong><br>
- Owner ka claim marketing aur trust build karne ka tareeqa hai.<br>
- Independent check aur actual user reports zyada reliable hain.<br>
- Large investment ya personal info share karne se pehle <strong>minimal test</strong> aur verification zaruri hai.
</p>

<style>
@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity: 1;}
}
</style>
            <p style="font-weight: bold; color: var(--secondary-color); margin-top: 20px;">Withdrawal shuru karne ke liye, Profile Icon (üë§) par click karke Login karen!</p>
        </div>
        
        <!-- Withdrawal Form and History (Hidden until login) -->
        <div id="withdrawalSection">
            
            <h2 style="color: var(--dark-bg); text-align: center;">Withdrawal Center (Authorized Access)</h2>
            
            <!-- Current Balance -->
            <div class="balance-info">
                <p>Aapka Maujooda Balance:</p>
                <h2 id="currentWithdrawalBalance">Loading...</h2>
                <p style="color: var(--danger-color); font-weight: bold;">Minimum Withdrawal: 1200 Coins (300 PKR)</p>
                <p style="font-weight: bold;">Exchange Rate: 4 Coins = 1 PKR</p>
            </div>

            <!-- Withdrawal Packages -->
            <h4 style="margin-top: 30px;">Withdrawal Amount Chunein (Coins)</h4>
            <div class="withdrawal-packages" id="withdrawalPackages">
                <!-- Buttons will be generated by JavaScript -->
            </div>

            <!-- Withdrawal Form -->
            <form id="withdrawalForm">
                <div class="form-group">
                    <label for="withdrawalAmount">Coins Ki Miqdar (Amount in Coins)</label>
                    <input type="number" id="withdrawalAmount" placeholder="Minimum 1200 Coins" required min="1200">
                    <p id="pkrEquivalent" style="font-size: 0.9em; color: var(--primary-color); margin-top: 5px;">Yeh lagbhag 0 PKR banenge.</p>
                </div>

                <div class="form-group">
                    <label for="paymentMethod">Payment Method Chunein</label>
                    <select id="paymentMethod" required>
                        <option value="">--- Chunein ---</option>
                        <optgroup label="Mobile Wallets">
                            <option value="EasyPaisa">EasyPaisa</option>
                            <option value="JazzCash">JazzCash</option>
                        </optgroup>
                        <optgroup label="Pakistani Banks">
                            <option value="HBL">Habib Bank Limited (HBL)</option>
                            <option value="UBL">United Bank Limited (UBL)</option>
                            <option value="MCB">MCB Bank Limited</option>
                            <option value="ABL">Allied Bank Limited (ABL)</option>
                            <option value="Meezan">Meezan Bank</option>
                            <option value="BankAlfalah">Bank Alfalah</option>
                            <option value="Askari">Askari Bank</option>
                            <option value="Faysal">Faysal Bank</option>
                            <option value="StandardChartered">Standard Chartered</option>
                        </optgroup>
                        <option value="Other">Doosra Bank</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="accountNumber">Account Number / Phone Number</label>
                    <input type="text" id="accountNumber" placeholder="Account Number ya Phone Number" required>
                </div>
                
                <div class="form-group">
                    <label for="accountHolderName">Account Holder Ka Naam</label>
                    <input type="text" id="accountHolderName" placeholder="Aapka Pura Naam" required>
                </div>

                <button type="submit" id="withdrawalButton">Withdrawal Request Bhejein</button>
            </form>
            
            <!-- Withdrawal History Section -->
            <div class="history-section">
                <h3>Withdrawal History</h3>
                <div id="historyList">
                    <p>Aapki requests load ho rahi hain...</p>
                </div>
            </div>
            
            <a href="index.html" id="backButton">‚Üê Wapas Home Page Par Jaen</a>
        </div>
    </div>
    
    <!-- 1. Auth Modal (Login/Signup) -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('authModal').style.display='none'">&times;</span>
            <h3 id="authTitle">Login Karen</h3>
            
            <form class="auth-form" id="authForm">
                <input type="email" id="authEmail" placeholder="Email Address" required>
                <input type="password" id="authPassword" placeholder="Password" required>
                <button type="submit" id="authButton">Login</button>
            </form>
            
            <div class="auth-toggle">
                <p id="toggleText">Account nahi hai? <a onclick="toggleAuthMode()">Signup Karen</a></p>
                <button id="logoutButton" style="display: none; background-color: #dc3545; margin-top: 15px;">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION AND INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNYv9SNUjMAHlaPzfovyYefoBNDgx4Gd4",
            authDomain: "traffic-exchange-62a58.firebaseapp.com",
            projectId: "traffic-exchange-62a58",
            storageBucket: "traffic-exchange-62a58.appspot.com",
            messagingSenderId: "474999317287",
            appId: "1:474999317287:web:8e28a2f5f1a959d8ce3f02",
            measurementId: "G-HJQ46RQNZS"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL STATE AND CONSTANTS ---
        let currentUser = null;
        let currentCoinBalance = 0;
        const COIN_RATE_PKR = 4; // 4 Coins = 1 PKR
        const MIN_WITHDRAWAL_COINS = 1200;
        const WITHDRAWAL_PACKAGES = [1200, 1800, 2400, 2800, 3400, 3800];
        let isSignupMode = false;

        // --- DOM ELEMENTS ---
        const currentWithdrawalBalance = document.getElementById('currentWithdrawalBalance');
        const withdrawalForm = document.getElementById('withdrawalForm');
        const withdrawalSection = document.getElementById('withdrawalSection');
        const authModal = document.getElementById('authModal');
        const historyList = document.getElementById('historyList');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const toggleText = document.getElementById('toggleText');
        const logoutButton = document.getElementById('logoutButton');
        const profileIconButton = document.getElementById('profileIconButton');
        const articleSection = document.querySelector('.article');
        const withdrawalAmountInput = document.getElementById('withdrawalAmount');
        const pkrEquivalentDisplay = document.getElementById('pkrEquivalent');
        const withdrawalPackagesContainer = document.getElementById('withdrawalPackages');


        // --- INITIAL SETUP: RENDER WITHDRAWAL PACKAGES ---
        function renderWithdrawalPackages() {
            withdrawalPackagesContainer.innerHTML = '';
            WITHDRAWAL_PACKAGES.forEach(coins => {
                const pkr = coins / COIN_RATE_PKR;
                const button = document.createElement('button');
                button.className = 'withdrawal-btn';
                button.setAttribute('type', 'button');
                button.setAttribute('data-coins', coins);
                button.textContent = `${coins} Coins (${pkr} PKR)`;
                withdrawalPackagesContainer.appendChild(button);
            });
        }
        renderWithdrawalPackages();

        // --- WITHDRAWAL PACKAGE SELECTION LOGIC ---
        withdrawalPackagesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('withdrawal-btn')) {
                const selectedCoins = Number(e.target.getAttribute('data-coins'));
                
                // 1. Update Input Field
                withdrawalAmountInput.value = selectedCoins;
                
                // 2. Update Visual Selection
                document.querySelectorAll('.withdrawal-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                e.target.classList.add('selected');
                
                // 3. Update PKR Equivalent Display
                updatePkrEquivalent(selectedCoins);
            }
        });
        
        // --- PKR EQUIVALENT CALCULATION ---
        function updatePkrEquivalent(coins) {
            const pkr = coins / COIN_RATE_PKR;
            pkrEquivalentDisplay.textContent = `Yeh lagbhag ${pkr.toFixed(2)} PKR banenge.`;
        }

        withdrawalAmountInput.addEventListener('input', (e) => {
            const coins = Number(e.target.value);
            updatePkrEquivalent(coins);
            
            // Remove selection from buttons if user types manually
            document.querySelectorAll('.withdrawal-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        });


        // --- EVENT LISTENER TO OPEN MODAL VIA ICON ---
        profileIconButton.addEventListener('click', () => {
            authModal.style.display = 'flex';
            if (!auth.currentUser) {
                isSignupMode = false;
                toggleAuthMode();
            }
        });


        // --- AUTH MODAL LOGIC ---
        function toggleAuthMode() {
            isSignupMode = !isSignupMode;
            if (isSignupMode) {
                authTitle.textContent = "Signup Karen";
                authButton.textContent = "Signup";
                toggleText.innerHTML = 'Account hai? <a onclick="toggleAuthMode()">Login Karen</a>';
            } else {
                authTitle.textContent = "Login Karen";
                authButton.textContent = "Login";
                toggleText.innerHTML = 'Account nahi hai? <a onclick="toggleAuthMode()">Signup Karen</a>';
            }
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            try {
                if (isSignupMode) {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).set({ coins: 0 });
                    alert("Signup Successful! Welcome.");
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    alert("Login Successful!");
                }
                authModal.style.display = 'none';
            } catch (error) {
                alert(`Authentication Failed: ${error.message}`);
            }
        });

        logoutButton.addEventListener('click', async () => {
            await auth.signOut();
            alert("Logout Successful.");
        });


        // --- AUTH CHECK AND WALLET LISTENER ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // Logged In: Show Withdrawal Section, Hide Article Guide
                articleSection.style.display = 'none';
                withdrawalSection.style.display = 'block';
                authModal.style.display = 'none';
                logoutButton.style.display = 'block';
                toggleText.style.display = 'none';
                
                listenToWallet(user.uid);
                listenToWithdrawalHistory(user.uid);
                updatePkrEquivalent(Number(withdrawalAmountInput.value) || MIN_WITHDRAWAL_COINS); // Initial PKR calculation

            } else {
                // Logged Out: Show Article Guide, Hide Withdrawal Section
                articleSection.style.display = 'block';
                withdrawalSection.style.display = 'none';
                logoutButton.style.display = 'none';
                toggleText.style.display = 'block';
                currentCoinBalance = 0;
            }
        });

        function listenToWallet(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const coins = data.coins ? Number(data.coins) : 0; 
                    currentCoinBalance = coins;
                    currentWithdrawalBalance.textContent = `${coins} Coins`;
                } else {
                    currentWithdrawalBalance.textContent = `0 Coins`;
                }
            }, error => {
                console.error("Error listening to wallet:", error);
            });
        }

        async function addCoinsToWallet(uid, amount) {
            const userRef = db.collection('users').doc(uid);
            try {
                await userRef.update({
                    coins: firebase.firestore.FieldValue.increment(amount) 
                });
            } catch (error) {
                console.error("Error updating wallet:", error);
            }
        }

        // --- HISTORY LOGIC ---

        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleDateString('en-PK', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            }
            return 'N/A';
        }

        function renderHistory(requests) {
            if (requests.length === 0) {
                historyList.innerHTML = '<p>Aapne abhi tak koi withdrawal request nahi bheji hai.</p>';
                return;
            }

            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Coins</th>
                            <th>PKR</th>
                            <th>Method</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            requests.forEach(req => {
                const statusClass = req.status.toLowerCase();
                // Display PKR amount in history
                const pkrAmount = req.pkrEquivalent ? req.pkrEquivalent.toFixed(2) : (req.coinsRequested / COIN_RATE_PKR).toFixed(2);
                
                html += `
                    <tr>
                        <td>${req.coinsRequested}</td>
                        <td>${pkrAmount} PKR</td>
                        <td>${req.paymentMethod}</td>
                        <td>${formatTimestamp(req.timestamp)}</td>
                        <td><span class="status-${statusClass}">${req.status}</span></td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            historyList.innerHTML = html;
        }

        function listenToWithdrawalHistory(uid) {
            db.collection('withdrawal_requests')
              .where('userId', '==', uid)
              .orderBy('timestamp', 'desc')
              .onSnapshot(snapshot => {
                  const requests = [];
                  snapshot.forEach(doc => {
                      requests.push(doc.data());
                  });
                  renderHistory(requests);
              }, error => {
                  console.error("Error fetching history:", error);
                  historyList.innerHTML = '<p style="color: var(--danger-color);">History load karne mein masla hua.</p>';
              });
        }


        // --- WITHDRAWAL LOGIC ---
        withdrawalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) return;

            const coinsRequested = Number(withdrawalAmountInput.value);
            const method = document.getElementById('paymentMethod').value;
            const accountNum = document.getElementById('accountNumber').value;
            const holderName = document.getElementById('accountHolderName').value;
            
            // Calculate PKR equivalent
            const pkrEquivalent = coinsRequested / COIN_RATE_PKR;

            if (coinsRequested < MIN_WITHDRAWAL_COINS) {
                alert(`Withdrawal ke liye kam az kam ${MIN_WITHDRAWAL_COINS} Coins chahiye.`);
                return;
            }
            
            // Check if coins are divisible by 4 to ensure whole PKR amount
            if (coinsRequested % COIN_RATE_PKR !== 0) {
                alert(`Coins ki miqdar ${COIN_RATE_PKR} se taqseem (divide) honi chahiye taake sahi PKR amount ban sake. Maslan: 1200, 1204, 1208, etc.`);
                return;
            }

            if (coinsRequested > currentCoinBalance) {
                alert("Aapke paas itne coins nahi hain.");
                return;
            }

            try {
                await db.collection('withdrawal_requests').add({
                    userId: currentUser.uid,
                    email: currentUser.email,
                    coinsRequested: coinsRequested,
                    pkrEquivalent: pkrEquivalent, // Store PKR amount
                    paymentMethod: method,
                    accountNumber: accountNum,
                    accountHolderName: holderName,
                    status: 'Pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Deduct coins
                await addCoinsToWallet(currentUser.uid, -coinsRequested);

                alert(`Withdrawal Request Bhej Di Gayi Hai! ${coinsRequested} Coins (${pkrEquivalent} PKR) aapke balance se kaat liye gaye hain.`);
                withdrawalForm.reset();
                updatePkrEquivalent(0); // Reset PKR display

            } catch (error) {
                console.error("Withdrawal failed:", error);
                alert("Withdrawal Request bhejte waqt koi masla hua. Dobara koshish karen.");
            }
        });
        
    </script>
</body>
</html>
