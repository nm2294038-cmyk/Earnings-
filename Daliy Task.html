<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Center - Open & Earn</title>
    
    <!-- Firebase SDKs (Version 8.10.0) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Font Awesome for Icons (Logos) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- VARIABLES --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --header-bg: #2c3e50;
            --card-bg: #ffffff;
            --warning-bg: #ffc107;
            --warning-text: #333;
            --button-cyan: #00bcd4;
            --dark-text: #333;
            --shadow-glow: 0 0 15px rgba(0, 188, 212, 0.5);
        }

        /* --- BASE STYLES (PC/Desktop View) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: var(--dark-text);
            line-height: 1.6;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.5em;
            margin: 0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* User Info (Email and Wallet) */
        #userInfo {
            display: none; /* Default hidden */
            flex-direction: column;
            align-items: flex-end;
            font-size: 0.9em;
            margin-right: 10px;
        }
        #userEmailDisplay { color: #ccc; margin: 0; }
        #walletIconContainer { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 5px; background: rgba(255, 255, 255, 0.1); }
        #walletIconContainer i { color: var(--warning-bg); font-size: 1.2em; }
        #coinsBalanceDisplay { font-weight: bold; color: white; }

        #profileIconButton { background: none; border: 2px solid white; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; padding: 0; border-radius: 50%; display: flex; justify-content: center; align-items: center; line-height: 1; transition: background-color 0.3s; }

        .container {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        
        /* --- VIEWS --- */
        #articleSection, #categoryMainSection, #taskMainSection {
            display: none; /* Managed by JS */
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        /* --- CATEGORY LIST STYLES --- */
        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .category-btn {
            background-color: var(--card-bg);
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-decoration: none;
            color: var(--dark-text);
        }
        .category-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        .category-btn i {
            font-size: 40px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        .category-btn span {
            font-weight: bold;
            display: block;
            font-size: 1.2em;
        }

        /* --- TASK CARD STYLING (Screenshot Style) --- */
        #taskList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .task-card {
            background-color: #333; /* Dark card background */
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            color: white;
        }
        .task-card:hover {
            transform: translateY(-3px);
        }

        .task-title { font-size: 1.4em; font-weight: bold; color: white; margin-bottom: 5px; }
        .task-platform { color: #aaa; margin-bottom: 15px; }

        .warning-box { background-color: #584b00; color: white; padding: 15px; border-radius: 8px; border-left: 5px solid var(--warning-bg); margin-bottom: 20px; text-align: right; direction: rtl; }
        .warning-box .urdu { font-size: 1.1em; margin-bottom: 5px; }
        .warning-box .english { font-size: 0.9em; color: var(--warning-bg); }

        .earn-button { background: var(--button-cyan); color: var(--dark-text); border: none; padding: 15px 25px; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(0, 188, 212, 0.5); width: 100%; transition: all 0.3s; }
        .earn-button:hover:not(:disabled) { background: #00e0e0; box-shadow: 0 0 20px rgba(0, 255, 255, 0.8); }
        .earn-button:disabled { background: #666; cursor: not-allowed; box-shadow: none; }

        /* --- AUTH MODAL STYLING --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--card-bg); padding: 40px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); position: relative; color: #333; }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 30px; font-weight: bold; cursor: pointer; }
        .auth-form input { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; padding: 10px; width: 100%; box-sizing: border-box; }
        .auth-form button { background-color: var(--primary-color); color: white; padding: 10px; border: none; border-radius: 4px; width: 100%; cursor: pointer; }
        .auth-toggle { margin-top: 20px; text-align: center; }
        .auth-toggle a { font-weight: bold; color: var(--primary-color); cursor: pointer; }

        /* --- SUCCESS POPUP --- */
        #successPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--secondary-color); color: white; padding: 20px 30px; border-radius: 10px; z-index: 10000; box-shadow: 0 0 20px rgba(40, 167, 69, 0.8); font-weight: bold; font-size: 1.2em; display: none; }


        /* ========================================= */
        /* --- RESPONSIVENESS (Mobile/Tablet) --- */
        /* ========================================= */

        /* Tablet View (Max 768px) */
        @media (max-width: 768px) {
            .category-list { grid-template-columns: repeat(2, 1fr); }
            #taskList { grid-template-columns: 1fr; }
        }

        /* Mobile View (Max 480px) */
        @media (max-width: 480px) {
            header { padding: 10px; }
            header h1 { font-size: 1.2em; }
            .category-list { grid-template-columns: 1fr; } /* Full width buttons */
            .category-btn { padding: 15px; }
            .task-title { font-size: 1.2em; }
            .warning-box .urdu { font-size: 1em; }
            .warning-box .english { font-size: 0.8em; }
        }
    </style>
</head>
<body>

    <header>
        <h1 id="mainHeaderTitle">Earning Categories</h1>
        <div class="header-right">
            <!-- User Info (Email and Wallet) -->
            <div id="userInfo">
                <p id="userEmailDisplay"></p>
                <div id="walletIconContainer">
                    <i class="fas fa-wallet"></i> 
                    <span id="coinsBalanceDisplay">0 Coins</span>
                </div>
            </div>
            <button id="profileIconButton" title="Login or Sign Up">üë§</button>
        </div>
    </header>

    <div class="container">
        
        <!-- 1. ARTICLE SECTION (Logged Out View) -->
        <section id="articleSection">
            <h2>Coins Kamane Aur Tasks Ka Mukammal Guide</h2>
            
            <p>Humari platform par aapka khushamdeed! Yeh woh markaz hai jahan aap aasan online tasks mukammal karke haqeeqi coins aur raqam kama sakte hain. Humara nizam is tarah design kiya gaya hai ke aapki har koshish ka sahi ajar mile.</p>

            <h3>1. Shuruat Kaise Karen: Registration Aur Login</h3>
            <p>Tasks tak rasai (access) hasil karne ke liye, sab se pehle aapko login ya signup karna hoga:</p>
            <ol>
                <li><strong>Profile Icon (üë§) Par Click Karen:</strong> Screen ke top right corner mein maujood profile icon par click karen.</li>
                <li><strong>Sign Up:</strong> Agar aap naye hain, to apni email, password aur naam darj karke fori account banaen.</li>
                <li><strong>Login:</strong> Agar aapka account pehle se hai, to seedha login karen.</li>
                <li>Login karte hi, yeh guide chhip jayega aur aapko categories nazar aana shuru ho jayengi.</li>
            </ol>
            <!-- ... rest of the article content ... -->
            <h3>2. Coins Kamane Ka Tareeqa (Earning Mechanism)</h3>
            <p>Aap mukhtalif social media platforms par engagement tasks karke coins kama sakte hain. Har task ki qeemat uski mushkil (difficulty) aur waqt ke hisaab se tay ki gayi hai. Aapko milne wali earning fori taur par aapke wallet mein jama ho jati hai.</p>
            <ul>
                <li><strong>YouTube:</strong> Videos dekhna, channel subscribe karna, aur likes dena.</li>
                <li><strong>TikTok:</strong> Videos like karna, follow karna, ya comments karna.</li>
                <li><strong>WhatsApp & App:</strong> Specific groups join karna ya apps download karna.</li>
            </ul>

            <h3>3. Tasks Ko Mukammal Karne Ki Hidayat (Instructions)</h3>
            <p>Har task ke saath ek **"Warning Box"** diya gaya hai. Yeh hidayat laazmi hain:</p>
            <ul>
                <li><strong>Har Task Ko Dhyan Se Parhen:</strong> Agar task mein sirf 'Open & Like' likha hai, to sirf wahi amal karen.</li>
                <li><strong>Mukammal Task:</strong> Task ko hidayat ke mutabiq mukammal karen. Agar aap adhoora task chhor dete hain ya ghalat amal karte hain, to aapki earning reject ho sakti hai.</li>
            </ul>

            <h3>4. Withdrawal Aur Coins Ki Qadar</h3>
            <p>Aapke kamaye hue coins ko aap baad mein PKR mein tabdeel karke withdraw kar sakte hain. Humari platform par har coin ki qadar wazahat ke saath di gayi hai (maslan: 4 Coins = 1 PKR).</p>
            
            <p style="font-weight: bold; color: var(--button-cyan); margin-top: 20px;">Intezar mat karen! Abhi login karen aur hazaron coins kamana shuru karen!</p>
        </section>
        
        <!-- 2. CATEGORY MAIN SECTION (Logged In View) -->
        <section id="categoryMainSection">
            <h2>Tasks Ki Categories Chunein</h2>
            
            <div class="category-list">
                <!-- Data-platform attribute will be used for filtering -->
                
                <a onclick="showTaskListView('YouTube')" class="category-btn">
                    <i class="fab fa-youtube" style="color: red;"></i> 
                    <span>YouTube Tasks</span>
                </a>
                
                <a onclick="showTaskListView('TikTok')" class="category-btn">
                    <i class="fab fa-tiktok" style="color: #69c9d0;"></i> 
                    <span>TikTok Tasks</span>
                </a>
                
                <a onclick="showTaskListView('Instagram')" class="category-btn">
                    <i class="fab fa-instagram" style="color: #E1306C;"></i> 
                    <span>Instagram Tasks</span>
                </a>
                
                <a onclick="showTaskListView('Facebook')" class="category-btn">
                    <i class="fab fa-facebook" style="color: #1877F2;"></i> 
                    <span>Facebook Tasks</span>
                </a>
                
                <a onclick="showTaskListView('WhatsApp')" class="category-btn">
                    <i class="fab fa-whatsapp" style="color: #25D366;"></i> 
                    <span>WhatsApp Tasks</span>
                </a>
                
                <a onclick="showTaskListView('App Download')" class="category-btn">
                    <i class="fas fa-mobile-alt" style="color: #007bff;"></i> 
                    <span>App Download Tasks</span>
                </a>
                
                <a onclick="showTaskListView('General')" class="category-btn">
                    <i class="fas fa-list" style="color: #555;"></i> 
                    <span>Other Tasks</span>
                </a>
            </div>
            
        </section>

        <!-- 3. TASK LIST SECTION (Hidden initially) -->
        <section id="taskMainSection">
            <a onclick="showCategoryView()" style="color: var(--primary-color); text-decoration: none; cursor: pointer;">‚Üê Wapas Categories Par Jaen</a>
            <h2 id="taskListHeaderTitle" style="text-align: center; margin-top: 15px;">Tasks</h2>
            
            <div id="taskList">
                <p style="text-align: center;">Tasks load ho rahe hain...</p>
            </div>
        </section>

    </div>
    
    <!-- AUTH MODAL -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('authModal').style.display='none'">&times;</span>
            <h3 id="authTitle">Login Karen</h3>
            
            <form class="auth-form" id="authForm">
                <input type="email" id="authEmail" placeholder="Email Address" required>
                <input type="password" id="authPassword" placeholder="Password" required>
                <button type="submit" id="authButton">Login</button>
            </form>
            
            <div class="auth-toggle">
                <p>Account nahi hai? <a href="index.html">Signup Page Par Jaen</a></p>
            </div>
        </div>
    </div>

    <!-- SUCCESS POPUP -->
    <div id="successPopup">
        ‚úÖ Coins aapke Wallet mein add kar diye gaye hain!
    </div>

    <script>
        // --- FIREBASE CONFIGURATION AND INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNYv9SNUjMAHlaPzfovyYefoBNDgx4Gd4",
            authDomain: "traffic-exchange-62a58.firebaseapp.com",
            projectId: "traffic-exchange-62a58",
            storageBucket: "traffic-exchange-62a58.appspot.com",
            messagingSenderId: "474999317287",
            appId: "1:474999317287:web:8e28a2f5f1a959d8ce3f02",
            measurementId: "G-HJQ46RQNZS"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM ELEMENTS ---
        const articleSection = document.getElementById('articleSection');
        const categoryMainSection = document.getElementById('categoryMainSection');
        const taskMainSection = document.getElementById('taskMainSection');
        const taskList = document.getElementById('taskList');
        const profileIconButton = document.getElementById('profileIconButton');
        const authModal = document.getElementById('authModal');
        const successPopup = document.getElementById('successPopup');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const coinsBalanceDisplay = document.getElementById('coinsBalanceDisplay');
        const userInfoDiv = document.getElementById('userInfo');
        const mainHeaderTitle = document.getElementById('mainHeaderTitle');
        const taskListHeaderTitle = document.getElementById('taskListHeaderTitle');


        let allTasks = []; 
        let currentUser = null;
        let currentView = 'categories';
        let currentFilterPlatform = 'All';

        // --- VIEW MANAGEMENT ---
        function showView(viewName) {
            articleSection.style.display = 'none';
            categoryMainSection.style.display = 'none';
            taskMainSection.style.display = 'none';

            if (!currentUser) {
                articleSection.style.display = 'block';
                mainHeaderTitle.textContent = 'Earning Guide';
                userInfoDiv.style.display = 'none';
                return;
            }

            userInfoDiv.style.display = 'flex';

            if (viewName === 'categories') {
                categoryMainSection.style.display = 'block';
                mainHeaderTitle.textContent = 'Tasks Categories';
                currentView = 'categories';
            } else if (viewName === 'tasks') {
                taskMainSection.style.display = 'block';
                mainHeaderTitle.textContent = `${currentFilterPlatform} Tasks`;
                currentView = 'tasks';
            }
        }
        
        function showCategoryView() {
            showView('categories');
        }

        function showTaskListView(platform) {
            currentFilterPlatform = platform;
            taskListHeaderTitle.textContent = `${platform} Tasks`;
            showView('tasks');
            renderTasks(platform);
        }

        // --- WALLET & LOGGING FUNCTION ---
        async function addCoinsToWallet(uid, amount, platform, link, type) {
            if (!uid) return false;
            const userRef = db.collection('users').doc(uid);
            const userEmail = currentUser.email;

            try {
                // 1. Update Wallet
                await userRef.update({
                    coins: firebase.firestore.FieldValue.increment(amount) 
                });

                // 2. Log Earning for Admin Panel (worker_earnings collection)
                await db.collection('worker_earnings').add({
                    userId: uid,
                    email: userEmail,
                    amount: amount,
                    source: platform,
                    type: type,
                    reference: link,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return true;
            } catch (error) {
                if (error.code === 'not-found') {
                     await userRef.set({ coins: amount, email: currentUser.email }, { merge: true });
                     return true;
                }
                console.error("Error updating wallet/logging earning:", error);
                return false;
            }
        }

        // --- UI POPUP FUNCTION ---
        function showSuccessPopup(message) {
            successPopup.textContent = message;
            successPopup.style.display = 'block';
            setTimeout(() => {
                successPopup.style.display = 'none';
            }, 3000);
        }

        // --- AUTH HANDLING ---
        profileIconButton.addEventListener('click', () => {
            if (currentUser) {
                if (confirm("Aap pehle se logged in hain. Kya aap logout karna chahte hain?")) {
                    auth.signOut();
                }
            } else {
                authModal.style.display = 'flex';
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                authModal.style.display = 'none';
            } catch (error) {
                alert(`Login Failed: ${error.message}`);
            }
        });

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                showView('categories');
                userInfoDiv.style.display = 'flex';
                userEmailDisplay.textContent = user.email; 
                
                fetchTasks();
                listenToWallet(user.uid); 
            } else {
                showView('article');
            }
        });

        // --- WALLET LISTENER (For Header Display) ---
        function listenToWallet(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const coins = Number(data.coins) || 0;
                    coinsBalanceDisplay.textContent = `${coins.toLocaleString()} Coins`;
                } else {
                    coinsBalanceDisplay.textContent = `0 Coins`;
                }
            });
        }


        // --- TASK FETCHING ---
        function fetchTasks() {
            // Fetch all approved tasks and store them locally
            db.collection('tasks').where('status', '==', 'Approved').onSnapshot(snapshot => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // If we are currently viewing tasks, re-render them with new data
                if (currentView === 'tasks') {
                    renderTasks(currentFilterPlatform);
                }

            }, error => {
                console.error("Error fetching tasks:", error);
                if (currentView === 'tasks') {
                    taskList.innerHTML = `<p style="color: var(--danger-color);">Tasks load nahi ho sake. Database connection check karen.</p>`;
                }
            });
        }

        // --- TASK RENDERING ---
        function renderTasks(platform) {
            taskList.innerHTML = '';
            let filteredTasks = allTasks;

            if (platform !== 'All' && platform !== 'General') {
                filteredTasks = allTasks.filter(task => task.platform === platform);
            } else if (platform === 'General') {
                filteredTasks = allTasks.filter(task => !['YouTube', 'TikTok', 'Instagram', 'Facebook', 'WhatsApp', 'App Download'].includes(task.platform));
            }
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `<p style="text-align: center;">Is category mein koi task maujood nahi hai.</p>`;
                return;
            }

            filteredTasks.forEach(task => {
                const title = task.linkTitle || task.type || 'New Task'; 
                const platformName = task.platform || 'General';
                const coinsToEarn = task.coinsRate || 0;
                const earnAmountDisplay = (coinsToEarn / 1000).toFixed(2); 
                
                const clicksRemaining = task.maxClicks - (task.currentClicks || 0);
                const clicksCompleted = task.currentClicks || 0;

                const card = document.createElement('div');
                card.className = 'task-card';

                card.innerHTML = `
                    <div class="task-title">${title}</div>
                    <div class="task-platform">${platformName}</div>
                    
                    <div class="warning-box">
                        <div class="urdu">ŸÑÿßÿ≤ŸÖ€å ÿßŸÜÿ™ÿ®ÿß€Å: ÿß⁄Øÿ± Ÿπÿßÿ≥⁄© €ÅÿØÿß€åÿßÿ™ ⁄©€í ŸÖÿ∑ÿßÿ®ŸÇ ŸÖ⁄©ŸÖŸÑ ŸÜ€Å€å⁄∫ ⁄©€åÿß ⁄Ø€åÿß ÿ™Ÿà ÿ¢Ÿæ ⁄©ÿß Ÿàÿ™⁄æ⁄àÿ±ÿßŸàŸÑ ŸÖÿ≥ÿ™ÿ±ÿØ ⁄©ÿ± ÿØ€åÿß ÿ¨ÿßÿ¶€í ⁄Øÿß€î</div>
                        <div class="english">Warning: If the task isn't completed correctly, your withdrawal will be rejected.</div>
                    </div>
                    
                    <button class="earn-button" 
                            data-link="${task.link}" 
                            data-task-id="${task.id}"
                            data-platform="${platformName}"
                            data-coins="${coinsToEarn}"
                            data-type="${task.type || 'Click'}"
                            onclick="handleTaskClick(this)">
                        Open & Earn ‚Çπ${earnAmountDisplay} (Clicks: ${clicksCompleted}/${clicksRemaining})
                    </button>
                `;
                taskList.appendChild(card);
            });
        }
        
        // --- HANDLE TASK CLICK (Earning Logic - INSTANT) ---
        window.handleTaskClick = async function(button) {
            if (!currentUser) {
                alert("Task shuru karne ke liye pehle login karen.");
                document.getElementById('profileIconButton').click();
                return;
            }

            const link = button.dataset.link;
            const coinsToEarn = Number(button.dataset.coins);
            const platform = button.dataset.platform;
            const type = button.dataset.type;
            
            if (coinsToEarn <= 0) {
                 alert("Is task ki earning 0 hai.");
                 return;
            }
            
            button.disabled = true;
            button.textContent = "Processing...";
            
            // 1. Open the link in a new tab (Simulates viewing the task)
            window.open(link, '_blank');
            
            // 2. INSTANT COIN ADDITION & LOGGING
            const success = await addCoinsToWallet(currentUser.uid, coinsToEarn, platform, link, type);
            
            if (success) {
                showSuccessPopup(`‚úÖ ${coinsToEarn.toLocaleString()} Coins aapke Wallet mein fori taur par add kar diye gaye hain!`);
            } else {
                alert("Coins add karne mein masla hua.");
            }

            // Reset button state
            button.textContent = "Task Completed (Earning Done)";
        }
        
        // --- INITIAL LOAD ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                showView('categories');
                userInfoDiv.style.display = 'flex';
                userEmailDisplay.textContent = user.email; 
                
                fetchTasks();
                listenToWallet(user.uid); 
            } else {
                showView('article');
            }
        });
    </script>
</body>
</html>
