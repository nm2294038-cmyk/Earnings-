<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Task Submission Center</title>
    
    <!-- Firebase SDKs (Version 8.10.0) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --dark-bg: #2c3e50;
            --light-bg: #ffffff;
            --danger-color: #dc3545;
            --pending-color: #ffc107;
            --completed-color: #28a745;
            --shadow-deep: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        /* --- HEADER STYLES --- */
        header {
            background-color: var(--dark-bg);
            color: white;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.5em;
            margin: 0;
            text-align: left;
        }

        /* Right side of header (Wallet + Icon) */
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #currentBalanceDisplay {
            background-color: var(--secondary-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
            display: none; /* Hidden until logged in */
        }

        #profileIconButton {
            background: none;
            border: 2px solid white;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            transition: background-color 0.3s;
        }
        #profileIconButton:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        /* --- MAIN CONTAINER --- */
        .container {
            width: 90%;
            max-width: 800px;
            margin: 40px auto;
            background-color: var(--light-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Login Prompt (Hidden when article is visible) */
        #loginPrompt {
            display: none;
        }

        /* Article Styling */
        .guide-article {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-left: 5px solid var(--primary-color);
            border-radius: 5px;
        }
        .guide-article h3 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .guide-article strong {
            color: var(--danger-color);
        }
        .guide-article ol {
            margin-left: 0;
            padding-left: 20px;
        }
        .guide-article .call-to-action {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 5px;
            font-weight: bold;
        }

        /* Task Section (Hidden until login) */
        #taskSubmissionSection {
            display: none;
        }

        /* --- FORM STYLING --- */
        .form-group label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        #coinsRequiredDisplay {
            font-weight: bold;
            color: var(--danger-color);
            margin-top: 10px;
            display: block;
        }

        #submitTaskButton {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1.1em;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        #submitTaskButton:hover {
            background-color: #0056b3;
        }
        #submitTaskButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* --- HISTORY STYLING --- */
        .history-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        .history-table th {
            background-color: #f4f4f4;
        }

        .status-pending { color: var(--pending-color); font-weight: bold; }
        .status-completed, .status-approved { color: var(--completed-color); font-weight: bold; }
        .status-rejected { color: var(--danger-color); font-weight: bold; }
        
        /* --- AUTH MODAL STYLING --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--light-bg);
            padding: 40px;
            border-radius: 12px;
            width: 90%; 
            max-width: 400px;
            box-shadow: var(--shadow-deep);
            position: relative;
        }
        
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
        }

        #authTitle {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .auth-form input {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .auth-form button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
        }

        .auth-toggle {
            margin-top: 20px;
            text-align: center;
        }
        
        .auth-toggle a {
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <h1>User Task Submission</h1>
        <div class="header-right">
            <!-- Wallet Display -->
            <div id="currentBalanceDisplay">Loading...</div>
            <!-- Profile Icon -->
            <button id="profileIconButton" title="Login or View Profile">üë§</button>
        </div>
    </header>

    <div class="container">
        
        <!-- ARTICLE/GUIDE SECTION (Visible when logged out) -->
        <div id="articleSection">
            <h2 style="color: var(--dark-bg); text-align: center;">Apne Social Media Ko Real Growth Dein</h2>
            
            <div class="guide-article">
                <h3>1. Shuruat Karen: Sign Up Aur Login</h3>
                <p>Is system ka istemal karne ke liye, aapka account hona zaroori hai. Amal nihayat aasan hai:</p>
                <p><strong>Green Flags (Safe-ish points)</strong><br>
1. SSL Certificate Present ‚Äì Website data encrypted hai.<br>
2. Functional Website ‚Äì Pages load hotay hain, links mostly active hain.<br>
3. Hosting Provider Known ‚Äì Website reputable hosting pe hai.<br>
4. Some Reviews Positive ‚Äì Limited users report ke platform functional hai.</p>

<p><strong>Red Flags (Risk points)</strong><br>
1. New Domain ‚Äì Domain register hui May 2025, matlab experience/track record kam hai.<br>
2. Owner Info Private ‚Äì Whois data hide hai, transparency ka issue.<br>
3. Unrealistic Earning Claims ‚Äì ‚ÄúInvite friends, earn daily‚Äù jaisi offers typical get-rich-quick pattern me aati hain.<br>
4. Limited User Feedback ‚Äì Publicly verified withdrawal reports ya testimonials nahi milte.<br>
5. Region Limitations ‚Äì Mostly UK-based service, Pakistan users ke liye support aur payout uncertain.<br>
6. Heavy Social Media Promotions ‚Äì Overhyped posts aur ads, jo reliability ko question karte hain.</p>

<p><strong>Recommendation</strong><br>
- Do not invest large sums until proven withdrawals.<br>
- Agar sign-up karo, minimal test amount se start karo.<br>
- Verify withdrawal before giving full payment info.<br>
- Check company registration aur payment process properly.</p>
                <ol>
                    <li><strong>Profile Icon (üë§) Par Click Karen:</strong> Page ke top right corner mein maujood profile icon par click karen.</li>
                    <li><strong>Sign Up:</strong> Agar aap naye hain, to "Signup Karen" par click karen, apni email aur password daal kar account banaen.</li>
                    <li><strong>Login:</strong> Agar aapka account pehle se hai, to seedha email aur password daal kar login karen.</li>
                    <li>Login karte hi, aapka **Wallet Balance** header mein nazar aayega aur Task Submission Form khul jayega.</li>
                </ol>

                <h3>2. Real Followers Aur Engagement Hasil Karen</h3>
                <p>Humara yeh section aapko **mukammal Real Engagement** faraham karne ke liye design kiya gaya hai. Jab aap yahan koi link submit karte hain, to aapke kharch kiye gaye coins dusre users ko task complete karne ke liye diye jaate hain.</p>
                
                <p><strong>Real Engagement Ki Guarantee:</strong> Humara nizam is tarah kaam karta hai ke aapke links sirf haqeeqi (real) aur active users tak pahunchte hain. Humari guarantee hai ke aapko <strong>1 se lekar 1000 tak (ya usse zyada) Real Follows, Likes, aur Views</strong> milenge, jo aapke channel/profile ki growth mein madad karenge.</p>

                <h4>3. Task Submission Ka Tareeqa</h4>
                <ol>
                    <li><strong>Platform aur Task Chunein:</strong> Login ke baad, form mein apna social media platform (YouTube, TikTok, etc.) aur required task (maslan: YouTube Subscriber ya TikTok Follow) chunein.</li>
                    <li><strong>Coins Check Karen:</strong> Task chunte hi, uski qeemat (Coins) fori taur par aapko nazar aayegi.</li>
                    <li><strong>Link Submit Karen:</strong> Apne video/profile ka woh link daalen jahan aap engagement chahte hain.</li>
                    <li><strong>Admin Approval:</strong> Aapka link pehle Admin ke paas jayega. Admin check karega ke link sahi hai ya nahi.</li>
                    <li><strong>Task Status:</strong> Aapki request **Pending** status mein chali jayegi. Approval ke baad, aapka link users ko dikhaya jayega aur aapko real engagement milna shuru ho jayega.</li>
                </ol>
                <div class="call-to-action">
                    Login Karen aur Apne Coins Ko Real Social Media Growth Mein Lagaein!
                </div>
            </div>
        </div>
        <!-- END ARTICLE/GUIDE SECTION -->
        
        <!-- Task Submission Section (Visible only after login) -->
        <div id="taskSubmissionSection">
            
            <h2 style="color: var(--dark-bg); text-align: center;">Naya Task Submit Karen</h2>
            
            <form id="taskForm">
                
                <div class="form-group">
                    <label for="platformSelect">Social Media Platform Chunein</label>
                    <select id="platformSelect" required>
                        <option value="">--- Select Platform ---</option>
                        <option value="YouTube">YouTube</option>
                        <option value="TikTok">TikTok</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Facebook">Facebook</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskTypeSelect">Task Ki Qism (Type) Aur Coins</label>
                    <select id="taskTypeSelect" required disabled>
                        <option value="">--- Pehle Platform Chunein ---</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="taskLink">Video/Channel/Profile Link Submit Karen</label>
                    <input type="url" id="taskLink" placeholder="Task ka Link yahan darj karen" required>
                </div>
                
                <p id="coinsRequiredDisplay">0 Coins</p>

                <button type="submit" id="submitTaskButton" disabled>Task Submit Karen</button>
            </form>
            
            <!-- Task History Section -->
            <div class="history-section">
                <h3>Aapki Submitted Tasks</h3>
                <div id="taskHistoryList">
                    <p>Aapki requests load ho rahi hain...</p>
                </div>
            </div>
            
            <a href="withdrawal.html" style="display: block; text-align: center; margin-top: 20px; color: var(--primary-color);">Withdrawal Center Par Jaen ‚Üí</a>
        </div>
    </div>
    
    <!-- 1. Auth Modal (Login/Signup) -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('authModal').style.display='none'">&times;</span>
            <h3 id="authTitle">Login Karen</h3>
            
            <form class="auth-form" id="authForm">
                <input type="email" id="authEmail" placeholder="Email Address" required>
                <input type="password" id="authPassword" placeholder="Password" required>
                <button type="submit" id="authButton">Login</button>
            </form>
            
            <div class="auth-toggle">
                <p id="toggleText">Account nahi hai? <a onclick="toggleAuthMode()">Signup Karen</a></p>
                <button id="logoutButton" style="display: none; background-color: #dc3545; margin-top: 15px;">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION AND INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNYv9SNUjMAHlaPzfovyYefoBNDgx4Gd4",
            authDomain: "traffic-exchange-62a58.firebaseapp.com",
            projectId: "traffic-exchange-62a58",
            storageBucket: "traffic-exchange-62a58.appspot.com",
            messagingSenderId: "474999317287",
            appId: "1:474999317287:web:8e28a2f5f1a959d8ce3f02",
            measurementId: "G-HJQ46RQNZS"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- CONSTANTS (Task Costs) ---
        const DEFAULT_RATES = {
            YouTube: {
                'Subscriber': 28000,
                'Like': 2400,
                'View': 2400
            },
            TikTok: {
                'View': 6,
                'Like': 30,
                'Comment': 100,
                'Share': 4,
                'Saved': 2,
                'Follow': 100
            },
            Instagram: {
                'Follower': 3800,
                'Like': 2400,
                'View': 250
            },
            Facebook: {
                'Follower': 1600,
                'Post Reaction': 1200
            }
        };

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentCoinBalance = 0;
        let requiredCoins = 0;
        let isSignupMode = false;

        // --- DOM ELEMENTS ---
        const authModal = document.getElementById('authModal');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const toggleText = document.getElementById('toggleText');
        const logoutButton = document.getElementById('logoutButton');
        const profileIconButton = document.getElementById('profileIconButton');
        const currentBalanceDisplay = document.getElementById('currentBalanceDisplay');
        const articleSection = document.getElementById('articleSection'); // New element
        const taskSubmissionSection = document.getElementById('taskSubmissionSection');
        const taskForm = document.getElementById('taskForm');
        const platformSelect = document.getElementById('platformSelect');
        const taskTypeSelect = document.getElementById('taskTypeSelect');
        const requiredCoinsDisplay = document.getElementById('coinsRequiredDisplay');
        const submitTaskButton = document.getElementById('submitTaskButton');
        const taskHistoryList = document.getElementById('taskHistoryList');


        // --- AUTH MODAL LOGIC ---
        function toggleAuthMode() {
            isSignupMode = !isSignupMode;
            if (isSignupMode) {
                authTitle.textContent = "Signup Karen";
                authButton.textContent = "Signup";
                toggleText.innerHTML = 'Account hai? <a onclick="toggleAuthMode()">Login Karen</a>';
            } else {
                authTitle.textContent = "Login Karen";
                authButton.textContent = "Login";
                toggleText.innerHTML = 'Account nahi hai? <a onclick="toggleAuthMode()">Signup Karen</a>';
            }
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            try {
                if (isSignupMode) {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).set({ coins: 0 });
                    alert("Signup Successful! Welcome.");
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    alert("Login Successful!");
                }
                authModal.style.display = 'none';
            } catch (error) {
                alert(`Authentication Failed: ${error.message}`);
            }
        });

        logoutButton.addEventListener('click', async () => {
            await auth.signOut();
            alert("Logout Successful.");
        });

        profileIconButton.addEventListener('click', () => {
            authModal.style.display = 'flex';
            if (!auth.currentUser) {
                isSignupMode = false;
                toggleAuthMode();
            }
        });


        // --- WALLET LISTENER ---
        function listenToWallet(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const coins = data.coins ? Number(data.coins) : 0; 
                    currentCoinBalance = coins;
                    currentBalanceDisplay.textContent = `${coins} Coins`;
                    checkSubmissionEligibility();
                } else {
                    currentBalanceDisplay.textContent = `0 Coins`;
                    currentCoinBalance = 0;
                }
            });
        }

        async function addCoinsToWallet(uid, amount) {
            const userRef = db.collection('users').doc(uid);
            try {
                await userRef.update({
                    coins: firebase.firestore.FieldValue.increment(amount) 
                });
            } catch (error) {
                console.error("Error updating wallet:", error);
            }
        }

        // --- AUTH CHECK ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // Logged In: Show Task Section, Hide Article
                articleSection.style.display = 'none';
                taskSubmissionSection.style.display = 'block';
                currentBalanceDisplay.style.display = 'block';
                authModal.style.display = 'none';
                logoutButton.style.display = 'block';
                toggleText.style.display = 'none';
                
                listenToWallet(user.uid);
                listenToTaskHistory(user.uid);

            } else {
                // Logged Out: Show Article, Hide Task Section
                articleSection.style.display = 'block';
                taskSubmissionSection.style.display = 'none';
                currentBalanceDisplay.style.display = 'none';
                logoutButton.style.display = 'none';
                toggleText.style.display = 'block';
                currentCoinBalance = 0;
            }
        });

        // --- TASK FORM LOGIC ---

        platformSelect.addEventListener('change', () => {
            const platform = platformSelect.value;
            taskTypeSelect.innerHTML = '<option value="">--- Select Task Type ---</option>';
            taskTypeSelect.disabled = true;
            requiredCoins = 0;
            requiredCoinsDisplay.textContent = '0 Coins';

            if (platform && DEFAULT_RATES[platform]) {
                for (const taskType in DEFAULT_RATES[platform]) {
                    const coins = DEFAULT_RATES[platform][taskType];
                    const option = document.createElement('option');
                    option.value = taskType;
                    option.textContent = `${taskType} (${coins} Coins)`;
                    taskTypeSelect.appendChild(option);
                }
                taskTypeSelect.disabled = false;
            }
            checkSubmissionEligibility();
        });

        taskTypeSelect.addEventListener('change', () => {
            const platform = platformSelect.value;
            const type = taskTypeSelect.value;
            
            if (platform && type && DEFAULT_RATES[platform] && DEFAULT_RATES[platform][type]) {
                requiredCoins = DEFAULT_RATES[platform][type];
                requiredCoinsDisplay.textContent = `${requiredCoins} Coins`;
            } else {
                requiredCoins = 0;
                requiredCoinsDisplay.textContent = '0 Coins';
            }
            checkSubmissionEligibility();
        });
        
        function checkSubmissionEligibility() {
            if (requiredCoins > 0 && currentCoinBalance >= requiredCoins) {
                submitTaskButton.disabled = false;
                submitTaskButton.textContent = `Submit Karen (${requiredCoins} Coins Deduct Honge)`;
            } else {
                submitTaskButton.disabled = true;
                if (requiredCoins > 0) {
                    submitTaskButton.textContent = `Coins Kam Hain (${requiredCoins} Chahiye)`;
                } else {
                    submitTaskButton.textContent = `Task Submit Karen`;
                }
            }
        }


        // --- TASK SUBMISSION ---
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser || requiredCoins === 0 || currentCoinBalance < requiredCoins) {
                alert("Coins kam hain ya task select nahi kiya gaya.");
                return;
            }

            const platform = platformSelect.value;
            const type = taskTypeSelect.value;
            const link = document.getElementById('taskLink').value;
            const coins = requiredCoins;

            if (!confirm(`Kya aap ${coins} Coins kharch karke yeh task submit karna chahte hain?`)) {
                return;
            }

            try {
                // 1. Deduct Coins from Wallet (Negative amount)
                await addCoinsToWallet(currentUser.uid, -coins);

                // 2. Create Task Request Record
                await db.collection('user_tasks').add({
                    userId: currentUser.uid,
                    email: currentUser.email,
                    platform: platform,
                    type: type,
                    link: link,
                    coinsDeducted: coins,
                    status: 'Pending', // Admin will approve/reject this
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`Task Request Bhej Di Gayi! ${coins} Coins aapke wallet se kaat liye gaye hain.`);
                taskForm.reset();
                requiredCoins = 0;
                requiredCoinsDisplay.textContent = '0 Coins';
                platformSelect.dispatchEvent(new Event('change')); // Reset task type dropdown

            } catch (error) {
                console.error("Task submission failed:", error);
                alert("Task Request bhejte waqt koi masla hua. Dobara koshish karen.");
            }
        });
        
        // --- HISTORY LOGIC ---

        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleDateString('en-PK', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            }
            return 'N/A';
        }

        function renderTaskHistory(requests) {
            if (requests.length === 0) {
                taskHistoryList.innerHTML = '<p>Aapne abhi tak koi task request nahi bheji hai.</p>';
                return;
            }

            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Platform</th>
                            <th>Task Type</th>
                            <th>Coins Spent</th>
                            <th>Link</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            requests.forEach(req => {
                const statusClass = (req.status || 'Pending').toLowerCase();
                html += `
                    <tr>
                        <td>${req.platform}</td>
                        <td>${req.type}</td>
                        <td>${req.coinsDeducted}</td>
                        <td><a href="${req.link}" target="_blank">View Link</a></td>
                        <td>${formatTimestamp(req.timestamp)}</td>
                        <td><span class="status-${statusClass}">${req.status || 'Pending'}</span></td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            taskHistoryList.innerHTML = html;
        }

        function listenToTaskHistory(uid) {
            // NOTE: This query requires a composite index in Firestore: (userId Ascending, timestamp Descending)
            db.collection('user_tasks')
              .where('userId', '==', uid)
              .orderBy('timestamp', 'desc')
              .onSnapshot(snapshot => {
                  const requests = [];
                  snapshot.forEach(doc => {
                      requests.push(doc.data());
                  });
                  renderTaskHistory(requests);
              }, error => {
                  console.error("Error fetching task history:", error);
                  taskHistoryList.innerHTML = '<p style="color: var(--danger-color);">History load karne mein masla hua. (Masla hal karne ke liye Firebase Console mein Index banaen: user_tasks collection, userId Asc, timestamp Desc)</p>';
              });
        }
        
    </script>
</body>
</html>
