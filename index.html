
<!DOCTYPE html>
<html>
<head>
  <title>Free Earnings</title>
  <style>
    /* --- Base Styles --- */
    body { font-family: Arial, sans-serif; margin:0; background:#0d0d0d; color:#fff; line-height: 1.6; padding-bottom: 80px; /* Footer k overlap ko roknay k liye padding add ki gai */ }
    header { background: linear-gradient(to right, #0ff, #0cc); color:#000; padding:15px; text-align:center; font-size:24px; font-weight:bold; text-shadow:0 0 5px #0ff; box-shadow: 0 2px 5px rgba(0,255,255,0.3); }
    nav { display:flex; flex-wrap:wrap; justify-content:center; background:#111; padding:10px 0; border-bottom: 2px solid #0ff; }
    nav button { background: #fff; border: none; padding: 10px 15px; margin: 5px; color: #000; font-weight:bold; border-radius: 8px; cursor:pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    nav button:hover { box-shadow: 0 0 15px #0ff, 0 4px 8px rgba(0,0,0,0.3); transform: translateY(-2px); background: #f0f0f0; }
    nav button[data-section="adminPanel"] { background: #ffc107; color: #000; } /* Admin button style */
    nav button[data-section="adminPanel"]:hover { background: #e0a800; box-shadow: 0 0 15px #e0a800, 0 4px 8px rgba(0,0,0,0.3); }

    section { display:none; padding:20px; margin-top: 20px; }
    section.active { display:block; }

    /* --- Input and Buttons --- */
    input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea {
        padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #333; width: 100%; box-sizing: border-box; background-color: #222; color: #fff; font-size: 14px;
    }
    input:focus, select:focus, textarea:focus { border-color: #0ff; outline: none; box-shadow: 0 0 8px rgba(0, 255, 255, 0.5); }

    button.submitBtn {
        background: #0ff; color: #000; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 16px;
        display: inline-block;
        margin-top: 10px;
    }
    button.submitBtn:hover { box-shadow: 0 0 10px #0ff, 0 4px 8px rgba(0,255,255,0.3); background: #fff; color: #000; transform: translateY(-2px); }
    button.submitBtn:disabled { background: #555; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }

    /* --- Full Screen Auth Section --- */
    #authSection {
        position: fixed; /* Use fixed position */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9); /* Darker background for full screen */
        display: flex; /* Use flexbox for centering */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999; /* Ensure it's above other content */
        padding: 20px;
        box-sizing: border-box;
    }
    #authSection .auth-container { /* New container for centering form */
        max-width: 400px;
        width: 100%; /* Full width up to max-width */
        padding: 30px;
        background: rgba(17, 17, 17, 0.8);
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,255,255,0.2);
        text-align: center;
    }
    #authSection h2 { color: #0ff; margin-bottom: 25px; }
    #authSection hr { border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 255, 255, 0), rgba(0, 255, 255, 0.75), rgba(0, 255, 255, 0)); margin: 30px 0; }
    #authSection button.submitBtn { width: 100%; }

    /* --- Containers for Boxes --- */
    .dashboard-container, #tasksContainer, #forYouTasksContainer, #withdrawList, #adminTasksContainer, #adminLinksContainer, #depositList, #userLinksContainer, #publicLinksContainer { /* Added publicLinksContainer */
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px; /* Increased gap */
        margin-top: 25px;
    }

    /* --- Individual Boxes (Dashboard, Task, Withdraw, Link, Deposit History) --- */
    .dashboard-box, .taskBox, .withdrawBox, .linkBox, .depositBox, .userLinkBox { /* Added .userLinkBox */
        background: #1a1a1a; /* Darker background */
        padding: 20px;
        border-radius: 12px; /* More rounded corners */
        box-shadow: 0 5px 15px rgba(0, 255, 255, 0.15); /* Softer glow */
        min-width: 220px; /* Consistent min-width */
        text-align: center;
        flex-grow: 1;
        max-width: 280px; /* Consistent max-width */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .dashboard-box:hover, .taskBox:hover, .withdrawBox:hover, .linkBox:hover, .depositBox:hover, .userLinkBox:hover { /* Added hover for depositBox and userLinkBox */
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 255, 255, 0.3);
    }
    .taskBox p { margin-bottom: 15px; font-size: 15px; color: #ccc; }
    
    /* === NEW: Style for the warning inside each task box === */
    .task-warning {
        color: #ffc107; /* Yellow color for attention */
        font-weight: bold;
        font-size: 13px;
        margin-top: 10px;
        padding: 8px;
        background-color: rgba(255, 193, 7, 0.1); /* Faint yellow background */
        border-left: 3px solid #ffc107;
        border-radius: 4px;
        text-align: left; /* Keep text aligned to the left */
    }

    /* --- NEW STYLES FOR ADMIN PANEL --- */
    #adminPanel form {
        max-width: 600px;
        margin: 20px auto;
        background: #1a1a1a; /* Darker background */
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        border: 1px solid #333;
    }
    #adminPanel h2, #publicLinksSection h2 { /* Added publicLinksSection h2 */
        color: #0ff;
        text-align: center;
        margin-bottom: 25px;
        font-size: 28px;
    }
    #adminPanel input,
    #adminPanel select,
    #adminPanel textarea {
        background-color: #222;
        color: #fff;
        border: 1px solid #333;
        padding: 12px; /* Slightly larger padding */
    }
    #adminPanel input:focus,
    #adminPanel select:focus,
    #adminPanel textarea:focus {
        border-color: #0ff;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
    }
    #adminPanel .submitBtn {
        width: 100%;
        display: block;
        margin-top: 25px; /* More space above button */
    }
     /* Style for dynamically added link fields */
    .dynamic-link-input {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .dynamic-link-input input {
        flex-grow: 1;
        margin-bottom: 0; /* Remove bottom margin for better alignment */
        padding: 10px; /* Consistent padding */
    }
    .dynamic-link-input button {
        background: #dc3545; /* Red for remove */
        color: white;
        border: none;
        padding: 10px 12px; /* Adjusted padding */
        border-radius: 6px; /* Slightly more rounded */
        cursor: pointer;
        font-size: 14px; /* Adjusted font size */
        transition: all 0.3s ease;
        flex-shrink: 0; /* Prevent button from shrinking */
    }
    .dynamic-link-input button:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
    #adminPanel p { color: #ccc; margin-bottom: 10px; font-size: 13px; }

    /* --- Deposit Section Specific Styles --- */
    #deposit .deposit-info-box {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #333;
        text-align: left;
    }
    #deposit .deposit-info-box p { color: #ffc107; font-weight: bold; margin-bottom: 10px; }
    #deposit .deposit-info-box ul { padding-left: 20px; color: #ccc; }
    #deposit .deposit-info-box li { margin-bottom: 8px; }
    #deposit form { max-width: 500px; margin: 20px auto; padding: 25px; background: #1a1a1a; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2); }
    #deposit h3 { margin-top: 30px; color: #0ff; text-align: center; }

    /* Withdrawal Warning Box Style */
    .withdrawal-warning-box {
        background-color: #2a1a1a; 
        border: 1px solid #dc3545;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        text-align: left;
    }
    .withdrawal-warning-box h3 {
        color: #ffc107;
        margin-top: 0;
        font-size: 20px;
        border-bottom: 1px solid #555;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    .withdrawal-warning-box p {
        color: #f0f0f0;
        font-size: 15px;
        line-height: 1.7;
    }

    /* --- UPDATED FOOTER STYLE (FIXED) --- */
    footer {
        background:#111;
        padding: 15px 0;
        text-align:center;
        border-top:2px solid #0ff;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: fixed; /* Footer ko fixed kiya gaya */
        bottom: 0;       /* Screen k bottom par rakha gaya */
        left: 0;
        z-index: 100;    /* Baqi content k upar rakhne k liye */
    }
    .footer-links { display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; margin-bottom: 10px; }
    .footer-links a { color: #0ff; text-decoration: none; font-weight: bold; cursor: pointer; white-space: nowrap; transition: color 0.3s ease; }
    .footer-links a:hover { text-decoration: underline; color: #fff; }
    footer .copyright { font-size:13px; color:#aaa; margin:0; }

    /* --- Modal Styles --- */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8); /* Darker modal background */
        backdrop-filter: blur(5px); /* Slight blur effect */
    }
    .modal-content {
        background-color: #1a1a1a; /* Darker modal content */
        color: #fff;
        margin: 8% auto; /* Adjusted margin */
        padding: 30px 40px; /* Increased padding */
        border: 1px solid #0ff;
        border-radius: 12px; /* More rounded */
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.4); /* Stronger glow */
        position: relative;
    }
    .modal-close-btn {
        color: #aaa; /* Softer close button color */
        position: absolute;
        top: 15px;
        right: 25px;
        font-size: 35px; /* Larger close icon */
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    .modal-close-btn:hover { color: #0ff; }
    .modal-content h2 { color: #0ff; text-align: center; margin-bottom: 20px; font-size: 30px;}
    .modal-content p { line-height: 1.7; text-align: left; }
    .modal-content ul { text-align: left; list-style-position: inside; padding-left: 10px;}
    .modal-content li { margin-bottom: 10px; }

    /* --- Specific Sections --- */
    #tasks { /* ... existing styles ... */ }

    /* --- Profile Section --- */
    .profile-card {
        background: #1a1a1a; /* Darker */
        padding: 30px; /* More padding */
        border-radius: 12px; /* More rounded */
        box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2); /* Softer glow */
        max-width: 480px; /* Slightly wider */
        width: 90%;
        margin: 40px auto; /* More margin */
        text-align: center;
    }
    .profile-header { margin-bottom: 25px; }
    .profile-pic {
        width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #0ff; /* Thicker border */
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.6); /* Brighter glow */
        background-color: #333; display: flex; justify-content: center; align-items: center; font-size: 45px; font-weight: bold; color: white;
    }
    .profile-info h2 { margin: 12px 0 6px 0; color: #0ff; font-size: 30px; }
    .profile-info p { margin: 6px 0; color: #ccc; font-size: 17px; }
    .profile-info p.referral-code { font-weight: bold; color: #fff; background: #2a2a2a; padding: 8px 15px; border-radius: 6px; display: inline-block; margin-top: 12px; font-size: 15px; }
    .profile-stats { margin: 30px 0; padding: 20px 0; border-top: 1px solid #333; border-bottom: 1px solid #333; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; } /* Added flex-wrap and gap */
    .stat-item p { margin: 0; color: #aaa; font-size: 15px; }
    .stat-item h3 { margin: 6px 0 0 0; color: #fff; font-size: 24px; font-weight: bold; }
    .profile-actions { margin-top: 25px; }
    .profile-actions button { background: #0ff; color: #000; border: none; padding: 14px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 17px; }
    .profile-actions button:hover { box-shadow: 0 0 10px #0ff, 0 4px 8px rgba(0,255,255,0.3); background: #fff; color: #000; transform: translateY(-2px); }

    /* --- Withdrawal/Deposit Status Styles --- */
    .status-pending, .status-pending-verification { color: #ffc107; font-weight: bold; } /* Yellow */
    .status-approved { color: #28a745; font-weight: bold; } /* Green */
    .status-rejected { color: #dc3545; font-weight: bold; } /* Red */

    /* --- YouTube Video Section --- */
    #youtubeVideoSection { text-align: center; margin-top: 30px; padding: 20px; background: #1a1a1a; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 255, 255, 0.15); }
    #youtubeVideoSection h2 { color: #0ff; margin-bottom: 20px; }
    #youtubeVideoSection p { color: #ccc; font-size: 15px; }
    /* --- NEW styles for multiple videos --- */
    #videoPlayerContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px; /* Space between videos */
    }
    .video-item {
        width: 100%;
        max-width: 480px; /* Control max size of each video */
        aspect-ratio: 16 / 9; /* Maintain video aspect ratio */
    }
    .video-item iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 8px;
    }
    /* --- End of NEW styles --- */


    /* --- User Added Links Section --- */
    #userLinksSection {
        margin-top: 30px;
        padding: 25px;
        background: #1a1a1a;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 255, 255, 0.15);
    }
    #userLinksSection h2 {
        color: #0ff;
        text-align: center;
        margin-bottom: 25px;
        font-size: 28px;
    }
    #userLinksSection form {
        max-width: 500px;
        margin: 0 auto 30px auto; /* Center form, add bottom margin */
        background: #222;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        border: 1px solid #333;
    }
    #userLinksSection form label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
    #userLinksSection form input[type="text"],
    #userLinksSection form input[type="url"] {
        background-color: #333; /* Darker input */
        border: 1px solid #444;
    }
    #userLinksSection form input[type="text"]:focus,
    #userLinksSection form input[type="url"]:focus {
        border-color: #0ff;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    .userLinkBox .edit-delete-buttons button {
        background: #ffc107; /* Yellow for edit */
        color: #000;
        margin-right: 5px;
        padding: 8px 12px;
        font-size: 13px;
    }
    .userLinkBox .edit-delete-buttons button.delete-btn {
        background: #dc3545; /* Red for delete */
        color: white;
    }
    .userLinkBox .edit-delete-buttons button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    /* --- Category Filter Buttons --- */
    .category-filter-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        margin-bottom: 25px;
    }
    .category-filter-buttons button {
        background: #333;
        color: #fff;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s ease;
    }
    .category-filter-buttons button:hover {
        background: #555;
        transform: translateY(-1px);
    }
    .category-filter-buttons button.active {
        background: #0ff;
        color: #000;
        font-weight: bold;
    }

    /* --- Price Selection Modal --- */
    #priceSelectionModal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1001; /* Higher than other modals */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
    }
    #priceSelectionModal .modal-content {
        background-color: #1a1a1a;
        color: #fff;
        margin: 0 auto; /* Center modal horizontally */
        padding: 30px 40px;
        border: 1px solid #0ff;
        border-radius: 12px;
        width: 85%;
        max-width: 500px; /* Adjusted max-width for price selection */
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.4);
        position: relative;
        text-align: center; /* Center content within modal */
    }
    #priceSelectionModal .modal-close-btn {
        color: #aaa;
        position: absolute;
        top: 15px;
        right: 25px;
        font-size: 35px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    #priceSelectionModal .modal-close-btn:hover { color: #0ff; }
    #priceSelectionModal h2 { color: #0ff; margin-bottom: 20px; font-size: 30px; }
    .price-option {
        background: #222;
        padding: 15px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
        border: 1px solid #333;
    }
    .price-option:hover {
        background: #333;
        transform: translateY(-2px);
    }
    .price-option p { margin: 0; font-size: 16px; font-weight: bold; }
    .price-option span { color: #ffc107; font-size: 14px; } /* Price display */
    .price-selection-confirm-btn {
        background: #0ff;
        color: #000;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        font-size: 16px;
        margin-top: 20px; /* Space above confirm button */
    }
    .price-selection-confirm-btn:hover {
        box-shadow: 0 0 10px #0ff, 0 4px 8px rgba(0,255,255,0.3);
        background: #fff;
        color: #000;
        transform: translateY(-2px);
    }
    .price-selection-confirm-btn:disabled {
        background: #555;
        color: #aaa;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }


    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
        nav button { padding: 8px 12px; font-size: 13px; }
        .dashboard-container, #tasksContainer, #forYouTasksContainer, #withdrawList, #adminTasksContainer, #adminLinksContainer, #depositList, #userLinksContainer, #publicLinksContainer { /* Added publicLinksContainer */
            gap: 15px;
        }
        .dashboard-box, .taskBox, .withdrawBox, .linkBox, .depositBox, .userLinkBox {
            min-width: 180px;
            max-width: 45%; /* Allow two per row on smaller screens */
        }
        .modal-content { width: 90%; margin: 5% auto; }
        .profile-card { width: 95%; margin: 20px auto; }
        #deposit form { width: 90%; }
        #authSection .auth-container { margin: 20px auto; } /* Adjust margin for smaller screens */
        #userLinksSection form { width: 95%; }
        #priceSelectionModal .modal-content { width: 90%; } /* Adjust modal width for smaller screens */
        .video-item { max-width: 90%; }
    }
    @media (max-width: 480px) {
        header { font-size: 20px; padding: 12px; }
        nav { padding: 8px 0; }
        nav button { margin: 3px; padding: 8px 10px; font-size: 12px; }
        .dashboard-box, .taskBox, .withdrawBox, .linkBox, .depositBox, .userLinkBox {
            min-width: 150px;
            max-width: 100%; /* Full width on very small screens */
        }
        .modal-content h2 { font-size: 24px; }
        .modal-close-btn { font-size: 25px; top: 10px; right: 15px; }
        #authSection .auth-container { padding: 20px; } /* Less padding for auth form on very small screens */
        #userLinksSection form { padding: 20px; }
        #priceSelectionModal .modal-content { padding: 20px; } /* Less padding in price selection modal */
        .video-item { max-width: 100%; }
    }
  </style>
</head>
<body>

<header>Free Earnings And All Social  Media Promotion Available </header>

<!-- Auth Section -->
<section id="authSection" class="active">
  <div class="auth-container">
    <h2>Sign Up / Login</h2>
    <input type="text" id="signupName" placeholder="Name" required><br>
    <input type="email" id="signupEmail" placeholder="Email" required><br>
    <input type="password" id="signupPassword" placeholder="Password" required><br>
    <input type="text" id="signupReferralCode" placeholder="Referral Code (Optional)"><br>
    <button id="signupBtn" class="submitBtn">Sign Up</button>
    <hr>
    <input type="email" id="loginEmail" placeholder="Email" required><br>
    <input type="password" id="loginPassword" placeholder="Password" required><br>
    <button id="loginBtn" class="submitBtn">Login</button>
  </div>
</section>

<!-- Navigation (REORDERED and UPDATED) -->
<nav style="display:none;">
  <button data-section="dashboard">Dashboard</button>
  <button data-section="tasks">Tasks</button>
  <button data-section="profile">Profile</button>
  <button data-section="referrals">Referral</button>
  <button data-section="forYouPage">For You</button>
  <button data-section="withdrawals">Withdrawal</button>
  <button data-section="deposit">Deposit</button>
  <button data-section="publicLinksSection">Public Links</button> <!-- NEW -->
  <button data-section="userLinksSection">Add/Manage My Links</button> <!-- RENAMED -->
  <button data-section="youtubeVideo">Watch Video</button>
  <button id="adminPanelBtn" data-section="adminPanel" style="display:none;">Admin Panel</button>
  <button id="logoutBtn">Logout</button>
</nav>

<!-- Sections (REORDERED) -->

<!-- Dashboard Section -->
<section id="dashboard">
  <h2>Dashboard</h2>
  <p>Any Problems? Contact the owner via the footer links.</p>
  <div class="dashboard-container">
    <div class="dashboard-box">
      <p>Total Users</p>
      <h3 id="totalUsers">0</h3>
    </div>
    <div class="dashboard-box">
      <p>Active Tasks</p>
      <h3 id="totalTasks">0</h3>
    </div>
    <div class="dashboard-box">
      <p>Total Withdrawals</p>
      <h3 id="totalWithdrawals">0</h3>
    </div>
    <div class="dashboard-box">
      <p>Total Earnings</p>
      <h3 id="totalEarnings">₹0.00</h3>
    </div>
    <div class="dashboard-box">
      <p>Wallet Balance</p>
      <h3>₹<span id="walletBalance">0.00</span></h3>
    </div>
  </div>
  <p>Tasks ko samajhna aapki income barhane ke liye bohot zaroori hai.<br><br>
  <strong>1. Tasks ke Types:</strong><br>
  <ul>
    <li><strong>Website Visits/Clicks:</strong> Zyada tar tasks me aapko specified website visit karni hoti hai aur kuch actions perform karne hote hain.</li>
    <li><strong>Content Engagement:</strong> Isme short videos dekhna ya posts like karna shamil ho sakta hai.</li>
  </ul>
  <strong>2. Instructions Dhyan Se Padhen:</strong> Har task ke sath clear instructions hoti hai. Inko accurately follow karna bohot zaroori hai taake aapko payment mile.<br><br>
  <strong>3. Verification Process:</strong> Hamara system aapke actions track karta hai taake task completion verify ho sake. Jo tasks incomplete ya fraudulent samjhe jayenge unko credit nahi kiya jayega.</p>
  <p>Understanding how tasks work is crucial for maximizing your income.<br><br>
  <strong>1. Types of Tasks:</strong><br>
  <ul>
    <li><strong>Website Visits/Clicks:</strong> Most tasks involve visiting a specified website and performing certain actions.</li>
    <li><strong>Content Engagement:</strong> This could include watching short videos or liking posts.</li>
  </ul>
  <strong>2. READ INSTRUCTIONS CAREFULLY:</strong> Each task comes with a clear set of instructions. It is absolutely essential to read and follow these instructions precisely to get paid.<br><br>
  <strong>3. Verification Process:</strong> Our system tracks your actions to verify task completion. Tasks that are deemed incomplete or fraudulent will not be credited.</p>
</section>

<!-- Tasks Section -->
<section id="tasks">
  <h2>Tasks to Complete</h2>
  <p>Complete tasks to earn rewards. Cooldown: 5 minutes between completions.</p>
  <div class="category-filter-buttons" id="taskCategoryFilters">
      <button data-filter="all" class="active">All Categories</button>
      <button data-filter="YouTube">YouTube</button>
      <button data-filter="TikTok">TikTok</button>
      <button data-filter="Instagram">Instagram</button>
      <button data-filter="Facebook">Facebook</button>
      <button data-filter="App">App</button>
      <button data-filter="Products">Products</button>
      <button data-filter="Channel">Channel</button>
      <button data-filter="Web">Web</button>
  </div>
  <div id="tasksContainer"></div>
</section>

<!-- Profile Section -->
<section id="profile">
  <h2>My Profile</h2>
  <div class="profile-card">
    <div class="profile-header">
      <div id="userProfilePic" class="profile-pic"></div>
      <div class="profile-info">
        <h2 id="userName"></h2>
        <p id="userEmail"></p>
        <p>Referral Code: <span id="userRef" class="referral-code"></span></p>
      </div>
    </div>
    <div class="profile-stats">
      <div class="stat-item">
        <p>Account Balance</p>
        <h3>₹<span id="walletBalanceProfile">0.00</span></h3>
      </div>
      <div class="stat-item">
        <p>Total Referrals</p>
        <h3 id="totalReferralsCount">0</h3>
      </div>
      <div class="stat-item">
        <p>Referral Earnings</p>
        <h3>₹<span id="totalReferralEarnings">0.00</span></h3>
      </div>
    </div>
    <div class="profile-actions">
      <button id="editProfileBtn">Edit Profile</button>
    </div>
  </div>
</section>

<!-- Referrals Section -->
<section id="referrals">
  <h2>Referral Earnings</h2>
  <p>Share your referral link to earn rewards when new users join through your link!</p>
  <p><strong>You will earn a 5% commission for life on all tasks completed by your referred users.</strong></p>
  <input type="text" id="refLink" readonly style="cursor: copy; background: #2a2a2a;">
  <h3>Referred Users:</h3>
  <div id="refUsers"></div>
</section>

<!-- For You Page Section -->
<section id="forYouPage">
  <h2>For You</h2>
  <p>Here are some recommended tasks and links For You.</p>
  <div id="forYouTasksContainer" class="dashboard-container"></div>
</section>

<!-- Withdrawals Section -->
<section id="withdrawals">
  <h2>Request Withdrawal</h2>
  <div class="withdrawal-warning-box">
      <h3>انتہائی اہم انتباہ - Warning</h3>
      <p>
          آپ کا Withdrawal اسی صورت میں منظور (Approve) کیا جائے گا جب آپ نے تمام Tasks بالکل اُسی طرح مکمل کیے ہوں گے جیسا کہ Task کی Description میں لکھا ہے۔ اگر آپ نے کوئی بھی ہدایت (Instruction) نظر انداز کی، ٹائمر پورا نہیں کیا، یا غلط کام کیا تو آپ کی Withdrawal Request بغیر کسی اطلاع کے مسترد (Reject) کر دی جائے گی اور اس فیصلے پر کوئی اپیل نہیں ہوگی۔
          <br><br>
          <strong>Your withdrawal will ONLY be approved if you have completed ALL tasks EXACTLY as instructed in the task description. If you ignore any instruction, do not wait for the full timer, or perform the task incorrectly, your withdrawal request will be REJECTED without notice, and this decision will be final.</strong>
      </p>
  </div>

  <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333;">
    <p style="color: #ffc107;"><strong>Important Withdrawal Information:</strong></p>
    <ul>
        <li>Payment dates are 19-22 and 28-31 of each month.</li>
        <li>If these dates fall on weekends or holidays, payments will be processed on the nearest business day.</li>
        <li>A two-week hold period applies after reaching the minimum payout amount.</li>
        <li>Minimum withdrawal: ₹1200 for Easypaisa/JazzCash/Bank, 12 USDT for Bitget.</li>
        <li>All withdrawal requests are manually reviewed.</li>
    </ul>
  </div>
  <form id="withdrawForm">
    <label for="withdrawMethod">Select Method:</label>
    <select id="withdrawMethod" required>
      <option value="Easypaisa">Easypaisa (03435640880 - Mujtaba Hassan)</option>
      <option value="JazzCash">JazzCash</option>
      <option value="Bank">Allied Bank</option>
      <option value="Bitget">Bitget USDT (Min 12 USDT)</option>
    </select><br>
    <input type="text" id="withdrawAccount" placeholder="Enter Your Account/Wallet Details" required><br>
    <input type="number" id="withdrawAmount" placeholder="Enter Amount (Min ₹1200)" required><br>
    <button type="submit" class="submitBtn">Request Withdrawal</button>
  </form>
  <h3>Your Withdrawal History:</h3>
  <div id="withdrawList"></div>
</section>

<!-- Deposit Section -->
<section id="deposit">
  <h2>Deposit Funds</h2>
  <p>Apne account mein funds add karne ke liye, neeche di gai hidayat follow karen:</p>
  <div class="deposit-info-box">
    <p><strong>Payment Details:</strong></p>
    <ul>
      <li><strong>Method:</strong> Easypaisa</li>
      <li><strong>Account Number:</strong> 03435640880</li>
      <li><strong>Account Name:</strong> Mujtaba Hassan</li>
    </ul>
    <p><strong>Instructions:</strong></p>
    <ul>
      <li>Apnay Easypaisa account se oper diye gaye number par raqam send karen.</li>
      <li>Raqam send karne ke baad, transaction ID ko copy karen.</li>
      <li>Neeche diye gaye form mein transaction ID aur amount enter karen aur Submit karen.</li>
      <li>Admin apki payment verify karega aur kuch dair mein aapka balance update ho jayega.</li>
    </ul>
  </div>
  <form id="depositForm">
    <input type="text" id="transactionId" placeholder="Enter Transaction ID" required><br>
    <input type="number" id="depositAmount" placeholder="Enter Amount to Deposit" required><br>
    <button type="submit" class="submitBtn">Submit Deposit Request</button>
  </form>
  <h3>Your Deposit History:</h3>
  <div id="depositList"></div>
</section>

<!-- Public Links Section (NEW) -->
<section id="publicLinksSection">
  <h2>Public Links</h2>
  <p>Explore links added by our community. You can only edit or delete the links you've added yourself.</p>
  <div id="publicLinksContainer" class="dashboard-container"></div>
</section>

<!-- User Added Links Section -->
<section id="userLinksSection">
  <h2>My Links</h2>
  <p>App 1 Free Add karwa Sakte Hain</p>
  <p>1 day k ley</p>
  <p>only website link</p>
  <p><b>Payment Account Name: Mujtbha Hassan</b></p>
  <p>Easypaisa Number: <b>03425640880</b></p>
  <p>1. 1st payment karein (per link charges: 200 PKR).</p>
  <p>2. Payment ka screenshot <b>mn1691316@gmail.com</b> par email karein.</p>
  <p>3. Transaction ID send karein.</p>
  <p>4. Apna naam bhejein.</p>
  <p>5. Apna WhatsApp number bhejein.</p>
  <p>6. Jo link add karwana chahte hain wo bhi <b>mn1691316@gmail.com</b> par email karein.</p>
  <p>7. Aap maximum 10 links add karwa sakte hain.</p>
  <p>8. Aur baki sab kuch bhi (agar koi additional information ya details hain) <b>mn1691316@gmail.com</b> par email karna hai.</p>
  <p>Add your own links here and earn rewards when others visit them. Select a category below to see its cost and add your link:</p>
  <ul>
    <li><strong>YouTube:</strong> ₹1200</li>
    <li><strong>Instagram:</strong> ₹1000</li>
    <li><strong>Facebook:</strong> ₹1600</li>
    <li><strong>TikTok:</strong> ₹200</li>
    <li><strong>Web:</strong> ₹150</li>
    <li><strong>App:</strong> ₹500 (Default if not specified)</li>
    <li><strong>Products:</strong> ₹500 (Default if not specified)</li>
    <li><strong>Channel:</strong> ₹500 (Default if not specified)</li>
    <li><strong>For You Page Promotion Life time k ley :</strong> ₹5000</li>
  </ul>
  <p>This Is Working</p>
  <form id="addUserLinkForm">
    <label for="userLinkUrl">Link URL:</label>
    <input type="url" id="userLinkUrl" placeholder="Enter URL (e.g., https://yourwebsite.com)" required><br>
    <label for="userLinkDescription">Link Description:</label>
    <input type="text" id="userLinkDescription" placeholder="Brief description for your link" required><br>
    <button type="submit" class="submitBtn">Add Link (Select Category & Cost)</button>
  </form>
  <h3>Your Added Links:</h3>
  <div id="userLinksContainer" class="dashboard-container"></div>
</section>

<!-- Price Selection Modal -->
<div id="priceSelectionModal" class="modal">
    <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h2>Select Category & Price</h2>
        <div id="priceOptionsContainer"></div>
        <button id="confirmPriceSelectionBtn" class="submitBtn price-selection-confirm-btn" disabled>Confirm & Add Link</button>
    </div>
</div>

<!-- Admin Panel Section -->
<section id="adminPanel">
    <h2>Admin Panel</h2>
    <form id="adminAddForm">
        <label for="adminItemType">Item Type:</label>
        <select id="adminItemType" required>
            <option value="task">Task</option>
            <option value="link">Link</option>
            <option value="youtubeVideo">YouTube Video</option>
        </select><br>
        <label for="adminCategory">Category (for Tasks/Links):</label>
        <select id="adminCategory" required>
            <option value="YouTube">YouTube</option>
            <option value="TikTok">TikTok</option>
            <option value="Instagram">Instagram</option>
            <option value="Facebook">Facebook</option>
            <option value="App">App</option>
            <option value="Products">Products</option>
            <option value="Channel">Channel</option>
            <option value="Web">Web</option>
        </select><br>
        <label for="adminDescription">Description (for Tasks/Links):</label>
        <input type="text" id="adminDescription" placeholder="e.g., Visit this website for 30 seconds"><br>
        <label for="adminBaseUrl">Main URL (for Tasks or YouTube Video):</label>
        <input type="text" id="adminBaseUrl" placeholder="e.g., https://example.com or YouTube URL"><br>
        <div id="dynamicLinkInputs">
            <p>Additional Links (for Link type only, up to 4):</p>
            <div class="dynamic-link-input"><input type="text" name="links[]" placeholder="Link 1 URL"></div>
            <div class="dynamic-link-input"><input type="text" name="links[]" placeholder="Link 2 URL"></div>
            <div class="dynamic-link-input"><input type="text" name="links[]" placeholder="Link 3 URL"></div>
            <div class="dynamic-link-input"><input type="text" name="links[]" placeholder="Link 4 URL"></div>
        </div>
        <label for="adminReward">Reward Amount (₹) - Optional for Tasks:</label>
        <input type="number" id="adminReward" placeholder="e.g., 0.07 (Overrides category default)" step="0.01"><br>
        <button type="submit" class="submitBtn">Add Earning Item</button>
    </form>
    <div style="margin-top: 40px;">
        <h3>Current Tasks:</h3>
        <div id="adminTasksContainer" class="dashboard-container"></div>
        <h3>Current Links:</h3>
        <div id="adminLinksContainer" class="dashboard-container"></div>
    </div>
</section>

<!-- YouTube Video Section (MOVED TO THE END) -->
<section id="youtubeVideoSection">
  <h2>Watch Videos to Earn</h2>
  <p>watch Video full earn 0.005$</p>
  <div id="videoPlayerContainer"></div>
  <p>Stay updated with our latest earning tips!</p>
</section>

<!-- Modal for Details -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <span class="modal-close-btn">&times;</span>
    <h2 id="modalTitle"></h2>
    <div id="modalText"></div>
  </div>
</div>

<!-- Footer -->
<footer>
  <div class="footer-links">
    <a id="privacyBtn">Privacy Policy</a>
    <a id="termsBtn">Terms of Service</a>
    <a id="aboutBtn">About Us</a>
    <a id="taskDetailsBtn">Task Details</a>
    <a id="withdrawalProfileBtn">Withdrawal Profile</a>
    <a id="contactEmailLink">Contact via Email</a>
    <a id="contactWhatsappLink">Contact via WhatsApp</a>
  </div>
  <p class="copyright">&copy; 2025 Free Earnings App. All Rights Reserved.</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, getDoc, getCountFromServer, Timestamp, query, where, deleteDoc, writeBatch, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDNYv9SNUjMAHlaPzfovyYefoBNDgx4Gd4",
    authDomain: "traffic-exchange-62a58.firebaseapp.com",
    projectId: "traffic-exchange-62a58",
    storageBucket: "traffic-exchange-62a58.appspot.com",
    messagingSenderId: "474999317287",
    appId: "1:474999317287:web:8e28a2f5f1a959d8ce3f02",
    measurementId: "G-HJQ46RQNZS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

// --- Global Constants and Configuration ---
const adminEmail = "mn1691316@gmail.com";
const whatsappNumber = "+923495144924";
const MIN_WITHDRAWAL_AMOUNT = 1200;
const TASK_EARNING_AMOUNT = 0.01;
const TASK_LINK_COOLDOWN_MS = 1 * 60 * 1000;
const REFERRAL_COMMISSION_RATE = 0.05; // 5%

const CATEGORY_EARNINGS = {
    "YouTube": 0.01, "Instagram": 0.01, "Facebook": 0.01, "TikTok": 0.10,
    "App": 0.50, "Web": 0.55, "Channel": 0.15, "Products": 10,
};

const PLATFORM_PRICES = {
    "YouTube": 1200, "Instagram": 1000, "Facebook": 1600,
    "TikTok": 200, "Web": 150, "For You": 5000
};
const CATEGORIES = ["YouTube", "TikTok", "Instagram", "Facebook", "App", "Products", "Channel", "Web"];
CATEGORIES.forEach(cat => {
    if (PLATFORM_PRICES[cat] === undefined) PLATFORM_PRICES[cat] = 500;
});
const MAX_USER_LINKS = 10;

// --- DOM Elements ---
const nav = document.querySelector("nav");
const adminPanelBtn = document.getElementById("adminPanelBtn");
const adminPanelSection = document.getElementById("adminPanel");
const authSection = document.getElementById("authSection");
const signupNameInput = document.getElementById("signupName");
const signupEmailInput = document.getElementById("signupEmail");
const signupPasswordInput = document.getElementById("signupPassword");
const signupReferralCodeInput = document.getElementById("signupReferralCode");
const signupBtn = document.getElementById("signupBtn");
const loginEmailInput = document.getElementById("loginEmail");
const loginPasswordInput = document.getElementById("loginPassword");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const refLinkInput = document.getElementById("refLink");
const depositForm = document.getElementById("depositForm");
const transactionIdInput = document.getElementById("transactionId");
const depositAmountInput = document.getElementById("depositAmount");
const depositListContainer = document.getElementById("depositList");
const adminAddForm = document.getElementById("adminAddForm");
const adminItemTypeSelect = document.getElementById("adminItemType");
const adminCategorySelect = document.getElementById("adminCategory");
const adminDescriptionInput = document.getElementById("adminDescription");
const adminBaseUrlInput = document.getElementById("adminBaseUrl");
const adminRewardInput = document.getElementById("adminReward");
const adminTasksContainer = document.getElementById("adminTasksContainer");
const adminLinksContainer = document.getElementById("adminLinksContainer");
const modal = document.getElementById("detailsModal");
const modalTitle = document.getElementById("modalTitle");
const modalText = document.getElementById("modalText");
const closeBtn = modal.querySelector(".modal-close-btn");
const privacyBtn = document.getElementById("privacyBtn");
const termsBtn = document.getElementById("termsBtn");
const aboutBtn = document.getElementById("aboutBtn");
const taskDetailsBtn = document.getElementById("taskDetailsBtn");
const withdrawalProfileBtn = document.getElementById("withdrawalProfileBtn");
const contactEmailLink = document.getElementById("contactEmailLink");
const contactWhatsappLink = document.getElementById("contactWhatsappLink");
const userProfilePic = document.getElementById("userProfilePic");
const userNameDisplay = document.getElementById("userName");
const userEmailDisplay = document.getElementById("userEmail");
const userRefDisplay = document.getElementById("userRef");
const walletBalanceDisplay = document.getElementById("walletBalance");
const walletBalanceProfileDisplay = document.getElementById("walletBalanceProfile");
const totalReferralsCountDisplay = document.getElementById("totalReferralsCount");
const totalReferralEarningsDisplay = document.getElementById("totalReferralEarnings");
const totalUsersDisplay = document.getElementById("totalUsers");
const totalTasksDisplay = document.getElementById("totalTasks");
const totalWithdrawalsDisplay = document.getElementById("totalWithdrawals");
const totalEarningsDisplay = document.getElementById("totalEarnings");
const dynamicLinkInputsContainer = document.getElementById("dynamicLinkInputs");
const addUserLinkForm = document.getElementById("addUserLinkForm");
const userLinkUrlInput = document.getElementById("userLinkUrl");
const userLinkDescriptionInput = document.getElementById("userLinkDescription");
const userLinksContainer = document.getElementById("userLinksContainer");
const forYouTasksContainer = document.getElementById("forYouTasksContainer");
const taskCategoryFilters = document.getElementById("taskCategoryFilters");
const priceSelectionModal = document.getElementById("priceSelectionModal");
const priceOptionsContainer = document.getElementById("priceOptionsContainer");
const confirmPriceSelectionBtn = document.getElementById("confirmPriceSelectionBtn");
const priceSelectionModalCloseBtn = priceSelectionModal.querySelector(".modal-close-btn");
const publicLinksContainer = document.getElementById("publicLinksContainer"); // NEW

let currentLinkToAdd = null;

// --- Helper Functions ---
function updateYouTubeVideoDisplay(videoDocs) {
    const videoContainer = document.getElementById("videoPlayerContainer");
    const videoSection = document.getElementById("youtubeVideoSection");
    if (!videoContainer || !videoSection) return;
    videoContainer.innerHTML = '';
    if (videoDocs && videoDocs.length > 0) {
        videoDocs.forEach(videoDoc => {
            const videoData = videoDoc.data();
            const videoUrl = videoData.url;
            if (videoUrl) {
                let videoId = '';
                if (videoUrl.includes("youtu.be/")) videoId = videoUrl.split("youtu.be/")[1].split("?")[0];
                else if (videoUrl.includes("youtube.com/watch?v=")) videoId = videoUrl.split("v=")[1].split("&")[0];
                else if (videoUrl.includes("youtube.com/embed/")) videoId = videoUrl.split("/embed/")[1].split("?")[0];
                if (videoId) {
                    const videoItemDiv = document.createElement('div');
                    videoItemDiv.classList.add('video-item');
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    iframe.frameBorder = "0";
                    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                    iframe.allowFullscreen = true;
                    videoItemDiv.appendChild(iframe);
                    videoContainer.appendChild(videoItemDiv);
                }
            }
        });
        videoSection.style.display = "block";
    } else {
        videoSection.style.display = "none";
    }
}

function clearAllCountdowns() {
    document.querySelectorAll('button[data-interval-id]').forEach(btn => {
        if (btn.dataset.intervalId) {
            clearInterval(parseInt(btn.dataset.intervalId));
            btn.dataset.intervalId = '';
        }
    });
}

function updateButtonState(button, itemId, itemType) {
    const lastOpenedKey = `${itemType}_${itemId}`;
    const lastOpenedTimestamp = localStorage.getItem(lastOpenedKey);
    if (button.dataset.intervalId) {
        clearInterval(parseInt(button.dataset.intervalId));
        button.dataset.intervalId = '';
    }
    if (!lastOpenedTimestamp) {
        button.disabled = false;
        const rewardAmount = parseFloat(button.dataset.reward);
        button.innerText = `Open & Earn ₹${rewardAmount.toFixed(2)}`;
        return;
    }
    const lastOpened = parseInt(lastOpenedTimestamp);
    const timeElapsed = new Date().getTime() - lastOpened;
    if (timeElapsed < TASK_LINK_COOLDOWN_MS) {
        button.disabled = true;
        const countdownInterval = setInterval(() => {
            const newTimeElapsed = new Date().getTime() - lastOpened;
            if (newTimeElapsed >= TASK_LINK_COOLDOWN_MS) {
                clearInterval(countdownInterval);
                button.disabled = false;
                const rewardAmount = parseFloat(button.dataset.reward);
                button.innerText = `Open & Earn ₹${rewardAmount.toFixed(2)}`;
                localStorage.removeItem(lastOpenedKey);
                button.dataset.intervalId = '';
            } else {
                const timeLeftMs = TASK_LINK_COOLDOWN_MS - newTimeElapsed;
                const minutes = Math.floor(timeLeftMs / 60000);
                const seconds = Math.floor((timeLeftMs % 60000) / 1000).toString().padStart(2, '0');
                button.innerText = `Wait ${minutes}:${seconds}`;
            }
        }, 1000);
        button.dataset.intervalId = countdownInterval;
    } else {
        button.disabled = false;
        const rewardAmount = parseFloat(button.dataset.reward);
        button.innerText = `Open & Earn ₹${rewardAmount.toFixed(2)}`;
        localStorage.removeItem(lastOpenedKey);
    }
}

function showSection(id) {
    document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
    const sectionToShow = document.getElementById(id);
    if (sectionToShow) sectionToShow.classList.add('active');
}

function showToast(message) { alert(message); }

function openLinkSafely(url) {
    if (!url || typeof url !== 'string' || !url.startsWith('http')) {
        showToast("Invalid URL provided.");
        return false;
    }
    try {
        const newWindow = window.open(url, '_blank');
        if (newWindow) {
            newWindow.focus();
            return true;
        } else {
            showToast("Pop-up blocked. Please allow pop-ups for this site or click the link directly.");
            createAndClickAnchor(url);
            return false;
        }
    } catch (e) {
        console.error("Error using window.open:", e);
        showToast("Could not open link directly. Trying an alternative method.");
        createAndClickAnchor(url);
        return false;
    }
}

function createAndClickAnchor(url) {
    const link = document.createElement('a');
    link.href = url;
    link.target = '_blank';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function generateReferralCode(uid) {
    const prefix = uid.substring(0, 4).toUpperCase();
    const suffix = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `${prefix}-${suffix}`;
}

function getCategoryFromDescription(description) {
    const lowerCaseDesc = description.toLowerCase();
    const CATEGORY_KEYWORDS = {
        "YouTube": ["youtube", "ytview", "ytlike", "ytshare", "ytcomment", "ytsaved"],
        "TikTok": ["tiktok", "ttview", "ttlike", "ttcomment", "ttshare"],
        "Instagram": ["instagram", "igview", "iglike", "igfollow", "igcomment"],
        "Facebook": ["facebook", "fbview", "fblike", "fbshare", "fbcomment"],
        "App": ["app"], "Products": ["products", "product"], "Channel": ["channel", "subscribe"],
        "Web": ["web", "website", "visit", "click"]
    };
    for (const mainCategory in CATEGORY_KEYWORDS) {
        if (CATEGORY_KEYWORDS[mainCategory].some(keyword => lowerCaseDesc.includes(keyword))) {
            return mainCategory;
        }
    }
    return "Web";
}

function filterTasks() {
    const activeMainBtn = document.querySelector("#taskCategoryFilters button.active");
    const mainCategory = activeMainBtn ? activeMainBtn.dataset.filter : 'all';
    const taskBoxes = document.querySelectorAll("#tasksContainer .taskBox");
    taskBoxes.forEach(box => {
        const taskMainCategory = box.dataset.category;
        const matchesMain = (mainCategory === 'all') || (taskMainCategory === mainCategory);
        
        if (matchesMain) {
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    });
}

// --- Authentication and UI State Management ---
onAuthStateChanged(auth, async user => {
    clearAllCountdowns();
    if (user) {
        authSection.style.display = "none";
        nav.style.display = "flex";
        showSection('dashboard'); // Default view
        if (user.email === adminEmail) {
            adminPanelBtn.style.display = "block";
            loadAdminDataIfAdmin(user);
        } else {
            adminPanelBtn.style.display = "none";
            if (adminPanelSection.classList.contains('active')) {
                showSection('dashboard');
            }
        }
        loadUserData(user);
        loadUserDepositHistory(user.uid);
        loadUserAddedLinks(user.uid);
        loadPublicLinks(); // NEW: Load public links for all logged-in users
        loadForYouContent(user.uid);
        const withdrawalsCol = collection(db, "withdrawals");
        onSnapshot(query(withdrawalsCol, where("userId", "==", user.uid), orderBy("timestamp", "desc")), snap => {
            const container = document.getElementById("withdrawList");
            container.innerHTML = "";
            snap.forEach(doc => {
                const w = doc.data();
                const withdrawDiv = document.createElement("div");
                withdrawDiv.classList.add("withdrawBox");
                const statusClass = 'status-' + w.status.toLowerCase().replace(/\s+/g, '-');
                let requestDate = 'N/A';
                if (w.timestamp && typeof w.timestamp.toDate === 'function') {
                    requestDate = w.timestamp.toDate().toLocaleString();
                } else if (w.timestamp) {
                    requestDate = new Date(w.timestamp).toLocaleString();
                }
                withdrawDiv.innerHTML = `<p><strong>Method:</strong> ${w.method}</p><p><strong>Account:</strong> ${w.accountNumber}</p><p><strong>Amount:</strong> ₹${w.amount.toFixed(2)}</p><p><strong>Status:</strong> <span class="${statusClass}">${w.status}</span></p><p><small>Requested: ${requestDate}</small></p>`;
                container.appendChild(withdrawDiv);
            });
        });
    } else {
        authSection.style.display = "block";
        nav.style.display = "none";
        showSection('authSection');
        adminPanelBtn.style.display = "none";
        userNameDisplay.innerText = ""; userEmailDisplay.innerText = ""; userRefDisplay.innerText = "";
        walletBalanceDisplay.innerText = "0.00"; walletBalanceProfileDisplay.innerText = "0.00";
        totalReferralsCountDisplay.innerText = "0"; refLinkInput.value = "";
        if (totalReferralEarningsDisplay) totalReferralEarningsDisplay.innerText = "0.00";
        userProfilePic.innerText = "?"; userProfilePic.style.backgroundImage = 'none'; userProfilePic.style.backgroundColor = '#333';
        totalUsersDisplay.innerText = "0"; totalTasksDisplay.innerText = "0";
        totalWithdrawalsDisplay.innerText = "0"; totalEarningsDisplay.innerText = "₹0.00";
        document.getElementById("withdrawList").innerHTML = "";
        depositListContainer.innerHTML = "";
        userLinksContainer.innerHTML = "";
        publicLinksContainer.innerHTML = ""; // NEW: Clear public links on logout
        forYouTasksContainer.innerHTML = "";
        document.getElementById("tasksContainer").innerHTML = "";
    }
});

// --- Event Listeners for Authentication ---
signupBtn.addEventListener("click", async () => {
    const name = signupNameInput.value.trim();
    const email = signupEmailInput.value.trim();
    const password = signupPasswordInput.value.trim();
    const referralCode = signupReferralCodeInput.value.trim();
    if (!name || !email || !password) { showToast("Please fill in all fields."); return; }
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await updateProfile(user, { displayName: name });
        let referrerDoc = null;
        let referredByUserId = null;
        if (referralCode) {
            const usersCol = collection(db, "users");
            const q = query(usersCol, where("referralCode", "==", referralCode));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                referrerDoc = querySnapshot.docs[0];
                referredByUserId = referrerDoc.id;
                showToast(`Welcome! You were referred by ${referrerDoc.data().name}.`);
            } else {
                showToast("Referral code not found. You will not be credited for a referral.");
            }
        }
        const newUserRefCode = generateReferralCode(user.uid);
        const newUserDocData = {
            name: name, email: email, wallet: 0, referralCode: newUserRefCode,
            referredBy: referredByUserId, createdAt: Timestamp.now(), referralCount: 0,
            userLinkCount: 0, totalReferralEarnings: 0
        };
        await setDoc(doc(db, "users", user.uid), newUserDocData);
        if (referrerDoc) {
            const batch = writeBatch(db);
            const referrerRef = doc(db, "users", referrerDoc.id);
            const currentReferralCount = referrerDoc.data().referralCount || 0;
            batch.update(referrerRef, { referralCount: currentReferralCount + 1 });
            await batch.commit();
        }
        showToast("Sign up successful! Please log in.");
        signupNameInput.value = ''; signupEmailInput.value = ''; signupPasswordInput.value = '';
        signupReferralCodeInput.value = '';
    } catch (error) {
        console.error("Sign up error:", error);
        showToast(`Sign up failed: ${error.message}`);
    }
});

loginBtn.addEventListener("click", async () => {
    const email = loginEmailInput.value.trim();
    const password = loginPasswordInput.value.trim();
    if (!email || !password) { showToast("Please enter your email and password."); return; }
    try {
        await signInWithEmailAndPassword(auth, email, password);
        showToast("Login successful!");
    } catch (error) {
        console.error("Login error:", error); showToast(`Login failed: ${error.message}`);
    }
});

logoutBtn.addEventListener("click", async () => {
    try {
        await signOut(auth);
        showToast("Logged out successfully.");
    } catch (error) {
        console.error("Logout error:", error); showToast(`Logout failed: ${error.message}`);
    }
});

// --- User Data Loading and Real-time Updates ---
function loadUserData(user) {
    const usersCol = collection(db, "users");
    const userRef = doc(db, "users", user.uid);
    const tasksCol = collection(db, "tasks");
    const youtubeVideosCol = collection(db, "youtubeVideos");
    const latestVideosQuery = query(youtubeVideosCol, orderBy("addedAt", "desc"), limit(30));
    onSnapshot(latestVideosQuery, (snapshot) => {
        updateYouTubeVideoDisplay(snapshot.docs);
    }, (error) => {
        console.error("Error fetching YouTube videos:", error);
        updateYouTubeVideoDisplay([]);
    });
    onSnapshot(userRef, async snap => {
        if (snap.exists()) {
            const data = snap.data();
            userNameDisplay.innerText = data.name || user.displayName || "N/A";
            userEmailDisplay.innerText = data.email || user.email;
            const referralCode = data.referralCode || generateReferralCode(user.uid);
            userRefDisplay.innerText = referralCode;
            refLinkInput.value = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;
            walletBalanceDisplay.innerText = (data.wallet || 0).toFixed(2);
            walletBalanceProfileDisplay.innerText = (data.wallet || 0).toFixed(2);
            totalReferralEarningsDisplay.innerText = (data.totalReferralEarnings || 0).toFixed(2);
            if (data.profilePicUrl) {
                userProfilePic.innerHTML = '';
                userProfilePic.style.backgroundImage = `url(${data.profilePicUrl})`;
                userProfilePic.style.backgroundSize = 'cover'; userProfilePic.style.backgroundPosition = 'center';
                userProfilePic.style.color = 'transparent';
            } else if (data.name) {
                const initials = data.name.trim().split(' ').map(word => word[0]).join('').toUpperCase();
                userProfilePic.innerText = initials;
                userProfilePic.style.backgroundImage = 'none';
                const colors = ['#1abc9c', '#3498db', '#9b59b6', '#f1c40f', '#e67e22', '#e74c3c'];
                userProfilePic.style.backgroundColor = colors[initials.charCodeAt(0) % colors.length];
            } else {
                userProfilePic.innerText = '?'; userProfilePic.style.backgroundColor = '#333';
                userProfilePic.style.backgroundImage = 'none';
            }
            const referralQuery = query(usersCol, where("referredBy", "==", user.uid));
            getCountFromServer(referralQuery).then(querySnapshot => {
                totalReferralsCountDisplay.innerText = querySnapshot.data().count;
            }).catch(error => console.error("Error getting referral count: ", error));
        } else {
            const referralCode = generateReferralCode(user.uid);
            await setDoc(userRef, {
                name: user.displayName || "New User", email: user.email, wallet: 0, referralCode: referralCode,
                referredBy: null, createdAt: Timestamp.now(), referralCount: 0, userLinkCount: 0,
                earningsHistory: {}, totalReferralEarnings: 0
            });
            showToast("Your profile data was initialized.");
            loadUserData(user);
        }
    });
    const tasksColRef = collection(db, "tasks");
    onSnapshot(tasksColRef, snap => {
        const container = document.getElementById("tasksContainer");
        container.innerHTML = "";
        snap.forEach(taskDoc => {
            const t = taskDoc.data();
            const taskId = taskDoc.id;
            const taskCategory = getCategoryFromDescription(t.description);
            const taskDiv = document.createElement("div");
            taskDiv.classList.add("taskBox");
            taskDiv.dataset.category = taskCategory;
            const reward = t.reward || CATEGORY_EARNINGS[taskCategory] || TASK_EARNING_AMOUNT;

            // === UPDATED PART: Added the warning message to each task ===
            taskDiv.innerHTML = `
                <p>${t.description}</p>
                <div class="task-warning">
                    <strong>لازمی انتباہ:</strong> اگر ٹاسک ہدایات کے مطابق مکمل نہیں کیا گیا تو آپ کا وتھڈراول مسترد کر دیا جائے گا۔<br>
                    <strong>Warning:</strong> If the task isn't completed correctly, your withdrawal will be rejected.
                </div>
                <button class="submitBtn" data-reward="${reward.toFixed(2)}" data-task-id="${taskId}">Open & Earn ₹${reward.toFixed(2)}</button>
            `;
            
            const button = taskDiv.querySelector("button");
            updateButtonState(button, taskId, 'task');
            button.addEventListener("click", async () => {
                const lastOpenedKey = `task_${taskId}`;
                const lastOpenedTimestamp = localStorage.getItem(lastOpenedKey);
                const lastOpened = lastOpenedTimestamp ? parseInt(lastOpenedTimestamp) : 0;
                const timeElapsed = new Date().getTime() - lastOpened;
                if (timeElapsed < TASK_LINK_COOLDOWN_MS) {
                    showToast("Please wait for the cooldown period to finish.");
                    return;
                }
                const linkOpened = openLinkSafely(t.url);
                if (linkOpened || !document.getElementById('popup-blocker-message')) {
                    localStorage.setItem(lastOpenedKey, new Date().getTime().toString());
                    updateButtonState(button, taskId, 'task');
                    try {
                        await addEarning(auth.currentUser.uid, taskCategory, reward);
                        showToast(`You earned ₹${reward.toFixed(2)} from ${taskCategory}!`);
                    } catch (error) {
                        console.error("An unexpected error occurred during task completion:", error);
                        showToast(`An error occurred: ${error.message}. Please try again.`);
                    }
                } else {
                    showToast("Could not open the task link. Please ensure the URL is valid.");
                }
            });
            container.appendChild(taskDiv);
        });
        filterTasks();
    });
    onSnapshot(usersCol, snap => { totalUsersDisplay.innerText = snap.size; });
    onSnapshot(tasksCol, snap => { totalTasksDisplay.innerText = snap.size; });
    onSnapshot(collection(db, "withdrawals"), snap => {
        totalWithdrawalsDisplay.innerText = snap.size;
        let totalApprovedWithdrawals = 0;
        snap.forEach(doc => {
            if (doc.data().status === "Approved") {
                totalApprovedWithdrawals += parseFloat(doc.data().amount || 0);
            }
        });
        totalEarningsDisplay.innerText = "₹" + totalApprovedWithdrawals.toFixed(2);
    });
}

// --- Deposit History Loading ---
function loadUserDepositHistory(userId) {
    const depositsCol = collection(db, "deposits");
    onSnapshot(query(depositsCol, where("userId", "==", userId), orderBy("timestamp", "desc")), snap => {
        depositListContainer.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const depositDiv = document.createElement("div");
            depositDiv.classList.add("withdrawBox");
            const statusClass = 'status-' + d.status.toLowerCase().replace(/\s+/g, '-');
            let requestDate = 'N/A';
            if (d.timestamp && typeof d.timestamp.toDate === 'function') {
                requestDate = d.timestamp.toDate().toLocaleString();
            } else if (d.timestamp) {
                requestDate = new Date(d.timestamp).toLocaleString();
            }
            depositDiv.innerHTML = `<p><strong>Tx ID:</strong> ${d.transactionId}</p><p><strong>Amount:</strong> ₹${d.amount.toFixed(2)}</p><p><strong>Status:</strong> <span class="${statusClass}">${d.status}</span></p><p><small>Submitted: ${requestDate}</small></p>`;
            depositListContainer.appendChild(depositDiv);
        });
    });
}

// --- Public Links Loading (UPDATED with OPEN BUTTON) ---
function loadPublicLinks() {
    const user = auth.currentUser;
    if (!user) {
        publicLinksContainer.innerHTML = "<p>Please log in to see public links.</p>";
        return;
    }
    const userAddedLinksCol = collection(db, "userAddedLinks");
    const q = query(userAddedLinksCol, orderBy("addedAt", "desc"));
    onSnapshot(q, snap => {
        publicLinksContainer.innerHTML = "";
        if (snap.empty) {
            publicLinksContainer.innerHTML = "<p>No public links have been added yet.</p>";
            return;
        }
        snap.forEach(doc => {
            const linkData = doc.data();
            const linkId = doc.id;
            const linkDiv = document.createElement("div");
            linkDiv.classList.add("userLinkBox");
            let buttonsHTML = '';
            // Check if the current user is the owner of the link
            if (linkData.addedByUserId === user.uid) {
                buttonsHTML = `
                    <div class="edit-delete-buttons">
                        <button class="edit-btn">Edit</button>
                        <button class="delete-btn">Delete</button>
                    </div>
                `;
            }
            linkDiv.innerHTML = `
                <p><strong>${linkData.description}</strong></p>
                <button class="submitBtn open-public-link-btn" style="margin-bottom: 10px; padding: 8px 20px; font-size: 14px;">Open</button>
                <small>Category: ${linkData.category || 'N/A'}</small><br>
                <small>Added: ${linkData.addedAt ? linkData.addedAt.toDate().toLocaleDateString() : 'N/A'}</small>
                ${buttonsHTML}
            `;
            
            const openBtn = linkDiv.querySelector('.open-public-link-btn');
            openBtn.addEventListener('click', () => openLinkSafely(linkData.url));

            // Add event listeners ONLY if buttons were rendered for the owner
            if (linkData.addedByUserId === user.uid) {
                linkDiv.querySelector('.edit-btn').addEventListener('click', () => editUserLink(linkId, linkData));
                linkDiv.querySelector('.delete-btn').addEventListener('click', () => deleteUserLink(linkId));
            }
            publicLinksContainer.appendChild(linkDiv);
        });
    });
}

// --- User Added Links Functions (for "My Links" section) ---
function loadUserAddedLinks(userId) {
    const userAddedLinksCol = collection(db, "userAddedLinks");
    const q = query(userAddedLinksCol, where("addedByUserId", "==", userId), orderBy("addedAt", "desc"));
    onSnapshot(q, snap => {
        userLinksContainer.innerHTML = "";
        if (snap.empty) {
            userLinksContainer.innerHTML = "<p>You haven't added any links yet.</p>";
            return;
        }
        snap.forEach(doc => {
            const linkData = doc.data();
            const linkId = doc.id;
            const linkDiv = document.createElement("div");
            linkDiv.classList.add("userLinkBox");
            linkDiv.innerHTML = `<p><strong>${linkData.description}</strong></p><p><a href="${linkData.url}" target="_blank" style="color: #0ff; text-decoration: none;">${linkData.url}</a></p><small>Category: ${linkData.category || 'N/A'}</small><br><small>Added: ${linkData.addedAt ? linkData.addedAt.toDate().toLocaleDateString() : 'N/A'}</small><br><div class="edit-delete-buttons"><button class="edit-btn">Edit</button><button class="delete-btn">Delete</button></div>`;
            linkDiv.querySelector('.edit-btn').addEventListener('click', () => editUserLink(linkId, linkData));
            linkDiv.querySelector('.delete-btn').addEventListener('click', () => deleteUserLink(linkId));
            userLinksContainer.appendChild(linkDiv);
        });
    });
}

async function editUserLink(linkId, currentData) {
    const newUrl = prompt("Edit Link URL:", currentData.url);
    if (newUrl === null) return;
    const newDescription = prompt("Edit Link Description:", currentData.description);
    if (newDescription === null) return;
    if (!newUrl.trim() || !newDescription.trim()) {
        showToast("URL and description cannot be empty."); return;
    }
    if (!newUrl.startsWith('http')) {
        showToast("Please enter a valid URL starting with http or https."); return;
    }
    try {
        await setDoc(doc(db, "userAddedLinks", linkId), {
            ...currentData, url: newUrl.trim(), description: newDescription.trim(),
            updatedAt: Timestamp.now()
        }, { merge: true });
        showToast("Link updated successfully!");
    } catch (error) {
        console.error("Error updating link:", error);
        showToast("Failed to update link. Please try again.");
    }
}

async function deleteUserLink(linkId) {
    if (!confirm("Are you sure you want to delete this link? This action cannot be undone.")) return;
    try {
        await deleteDoc(doc(db, "userAddedLinks", linkId));
        showToast("Link deleted successfully!");
    } catch (error) {
        console.error("Error deleting link:", error);
        showToast("Failed to delete link. Please try again.");
    }
}

// --- "For You" Page Logic ---
async function loadForYouContent(userId) {
    forYouTasksContainer.innerHTML = "";
    const keywords = ["nazim", "umar", "For You", "YouTube", "TikTok", "Instagram", "Facebook", "Google", "cpm"];
    const tasksCol = collection(db, "tasks");
    const linksCol = collection(db, "links");
    let itemsToDisplay = [];
    const tasksSnapshot = await getDocs(tasksCol);
    tasksSnapshot.forEach(doc => {
        const item = doc.data();
        if (item.description && keywords.some(keyword => item.description.toLowerCase().includes(keyword))) {
            itemsToDisplay.push({ ...item, id: doc.id, type: 'task' });
        }
    });
    const linksSnapshot = await getDocs(linksCol);
    linksSnapshot.forEach(doc => {
        const item = doc.data();
        if (item.description && keywords.some(keyword => item.description.toLowerCase().includes(keyword))) {
            itemsToDisplay.push({ ...item, id: doc.id, type: 'link' });
        }
    });
    if (itemsToDisplay.length === 0) {
        forYouTasksContainer.innerHTML = "<p>No specific tasks or links matching your criteria are available right now.</p>";
        return;
    }
    itemsToDisplay.forEach(item => {
        const itemDiv = document.createElement("div");
        itemDiv.classList.add("taskBox");
        itemDiv.innerHTML = `<p>${item.description}</p><button class="submitBtn">Visit</button>`;
        const button = itemDiv.querySelector("button");
        button.addEventListener("click", async () => {
            const urlToOpen = (item.type === 'task' && item.url) ? item.url :
                (item.type === 'link' && item.urls && item.urls.length > 0) ? item.urls[0] : null;
            if (!urlToOpen) { showToast("Invalid URL for this item."); return; }
            openLinkSafely(urlToOpen);
        });
        forYouTasksContainer.appendChild(itemDiv);
    });
}

// --- Event Listeners for Forms and Buttons ---
addUserLinkForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) { showToast("Please log in to add links."); return; }
    const url = userLinkUrlInput.value.trim();
    const description = userLinkDescriptionInput.value.trim();
    if (!url || !description) {
        showToast("Please enter both URL and description."); return;
    }
    if (!url.startsWith('http')) {
        showToast("Please enter a valid URL starting with http or https."); return;
    }
    currentLinkToAdd = { url, description };
    populatePriceSelectionModal();
    priceSelectionModal.style.display = "flex";
});

function populatePriceSelectionModal() {
    priceOptionsContainer.innerHTML = '';
    const sortedCategories = Object.keys(PLATFORM_PRICES).sort((a, b) => PLATFORM_PRICES[a] - PLATFORM_PRICES[b]);
    sortedCategories.forEach(category => {
        const price = PLATFORM_PRICES[category];
        const priceOptionDiv = document.createElement('div');
        priceOptionDiv.classList.add('price-option');
        priceOptionDiv.dataset.category = category;
        priceOptionDiv.dataset.price = price;
        priceOptionDiv.innerHTML = `<p>${category}</p><span>₹${price}</span>`;
        priceOptionDiv.addEventListener('click', () => selectPriceOption(priceOptionDiv));
        priceOptionsContainer.appendChild(priceOptionDiv);
    });
}

function selectPriceOption(selectedDiv) {
    priceOptionsContainer.querySelectorAll('.price-option').forEach(div => {
        div.style.backgroundColor = '#222';
        div.style.transform = 'translateY(0)';
        div.style.borderColor = '#333';
    });
    selectedDiv.style.backgroundColor = '#333';
    selectedDiv.style.borderColor = '#0ff';
    confirmPriceSelectionBtn.dataset.selectedPrice = selectedDiv.dataset.price;
    confirmPriceSelectionBtn.dataset.selectedCategory = selectedDiv.dataset.category;
    confirmPriceSelectionBtn.disabled = false;
}

confirmPriceSelectionBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user || !currentLinkToAdd) {
        showToast("Error: User not logged in or link details missing.");
        priceSelectionModal.style.display = "none"; return;
    }
    const selectedPrice = parseInt(confirmPriceSelectionBtn.dataset.selectedPrice);
    const selectedCategory = confirmPriceSelectionBtn.dataset.selectedCategory;
    if (isNaN(selectedPrice) || !selectedCategory) {
        showToast("Please select a valid category."); return;
    }
    const userRef = doc(db, "users", user.uid);
    let userDocSnap;
    try {
        userDocSnap = await getDoc(userRef);
    } catch (error) {
        console.error("Error fetching user document for adding link:", error);
        showToast("Failed to retrieve your account data. Please try again."); return;
    }
    if (!userDocSnap.exists()) {
        showToast("User profile not found. Please contact support."); return;
    }
    const userData = userDocSnap.data();
    const currentUserLinkCount = userData.userLinkCount || 0;
    if (currentUserLinkCount >= MAX_USER_LINKS) {
        showToast(`You have reached the maximum limit of ${MAX_USER_LINKS} added links.`);
        priceSelectionModal.style.display = "none"; return;
    }
    if ((userData.wallet || 0) < selectedPrice) {
        showToast(`Insufficient balance. You need at least ₹${selectedPrice} for ${selectedCategory}.`);
        priceSelectionModal.style.display = "none"; return;
    }
    try {
        const batch = writeBatch(db);
        batch.update(userRef, { wallet: (userData.wallet || 0) - selectedPrice });
        batch.update(userRef, { userLinkCount: currentUserLinkCount + 1 });
        const userAddedLinksCol = collection(db, "userAddedLinks");
        const newLinkRef = doc(userAddedLinksCol);
        batch.set(newLinkRef, {
            addedByUserId: user.uid, url: currentLinkToAdd.url, description: currentLinkToAdd.description,
            category: selectedCategory, addedAt: Timestamp.now(), status: "Active"
        });
        await batch.commit();
        showToast(`Link added to ${selectedCategory} successfully! ₹${selectedPrice} deducted from your wallet.`);
        addUserLinkForm.reset();
        priceSelectionModal.style.display = "none";
        currentLinkToAdd = null;
        confirmPriceSelectionBtn.disabled = true;
        confirmPriceSelectionBtn.dataset.selectedPrice = '';
        confirmPriceSelectionBtn.dataset.selectedCategory = '';
        priceOptionsContainer.querySelectorAll('.price-option').forEach(div => {
            div.style.backgroundColor = '#222'; div.style.borderColor = '#333';
        });
    } catch (error) {
        console.error("Error adding user link:", error);
        showToast("Failed to add link. Please try again.");
        priceSelectionModal.style.display = "none";
    }
});

document.getElementById("withdrawForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) { showToast("Please log in to request withdrawal."); return; }
    const method = document.getElementById("withdrawMethod").value;
    const accountNumber = document.getElementById("withdrawAccount").value.trim();
    const amount = parseFloat(document.getElementById("withdrawAmount").value);
    if (amount < MIN_WITHDRAWAL_AMOUNT) {
        showToast(`Minimum withdrawal amount is ₹${MIN_WITHDRAWAL_AMOUNT}.`); return;
    }
    if (!accountNumber) {
        showToast("Please enter your account details."); return;
    }
    const userRef = doc(db, "users", user.uid);
    let userDocSnap;
    try {
        userDocSnap = await getDoc(userRef);
    } catch (error) {
        console.error("Error fetching user document for withdrawal:", error);
        showToast("Failed to retrieve your account balance. Please try again."); return;
    }
    if (!userDocSnap.exists()) {
        showToast("User profile not found. Please contact support."); return;
    }
    const userData = userDocSnap.data();
    const currentWalletBalance = userData.wallet || 0;
    if (currentWalletBalance < amount) {
        showToast("Insufficient wallet balance for this withdrawal."); return;
    }
    try {
        const batch = writeBatch(db);
        batch.update(userRef, { wallet: currentWalletBalance - amount });
        const withdrawalRef = doc(collection(db, "withdrawals"));
        batch.set(withdrawalRef, {
            userId: user.uid, method: method, accountNumber: accountNumber, amount: amount,
            status: "Pending", timestamp: Timestamp.now()
        });
        await batch.commit();
        showToast("Withdrawal request submitted successfully and wallet balance deducted. It will be processed soon.");
        e.target.reset();
    } catch (error) {
        console.error("Error submitting withdrawal request or deducting balance:", error);
        showToast("Failed to submit withdrawal request or deduct balance. Please try again.");
    }
});

depositForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) { showToast("Please log in to deposit funds."); return; }
    const txId = transactionIdInput.value.trim();
    const amount = parseFloat(depositAmountInput.value);
    if (!txId || isNaN(amount) || amount <= 0) {
        showToast("Please enter a valid transaction ID and deposit amount."); return;
    }
    try {
        await addDoc(collection(db, "deposits"), {
            userId: user.uid, userName: user.displayName || user.email, transactionId: txId,
            amount: amount, status: "Pending Verification", timestamp: Timestamp.now()
        });
        showToast("Deposit request submitted successfully. Please wait for verification.");
        depositForm.reset();
    } catch (error) {
        console.error("Error submitting deposit request:", error); showToast("Failed to submit deposit request. Please try again.");
    }
});

adminAddForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const itemType = adminItemTypeSelect.value;
    const mainUrl = adminBaseUrlInput.value.trim();
    if (itemType === "youtubeVideo") {
        if (!mainUrl || !mainUrl.startsWith("http")) {
            showToast("Please enter a valid YouTube URL."); return;
        }
        try {
            await addDoc(collection(db, "youtubeVideos"), { url: mainUrl, addedAt: Timestamp.now() });
            showToast(`YouTube Video added successfully!`);
            adminAddForm.reset();
        } catch (error) {
            console.error("Error adding YouTube video:", error);
            showToast(`Failed to add YouTube video. Please try again.`);
        }
        return;
    }
    const selectedCategory = adminCategorySelect.value;
    const description = adminDescriptionInput.value.trim();
    const reward = adminRewardInput.value ? parseFloat(adminRewardInput.value) : null;
    const linkInputs = adminAddForm.querySelectorAll('.dynamic-link-input input');
    const urls = Array.from(linkInputs).map(input => input.value.trim()).filter(url => url);
    if (!description) {
        showToast("Please provide a description for tasks/links."); return;
    }
    if (reward !== null && (isNaN(reward) || reward <= 0)) {
        showToast("If providing a reward, it must be a valid positive number."); return;
    }
    const categoryFromDesc = getCategoryFromDescription(description);
    const finalCategory = (categoryFromDesc !== "Web") ? categoryFromDesc : selectedCategory;
    let itemData = { description, category: finalCategory, createdAt: Timestamp.now() };
    if (reward) itemData.reward = reward;
    let collectionRef;
    if (itemType === "task") {
        if (!mainUrl || !mainUrl.startsWith("http")) {
            showToast("Please enter a valid URL for tasks."); return;
        }
        collectionRef = collection(db, "tasks");
        itemData.url = mainUrl;
    } else if (itemType === "link") {
        if (!urls || urls.length === 0) {
            showToast("Please enter at least one URL for links."); return;
        }
        collectionRef = collection(db, "links");
        itemData.urls = urls;
    } else {
        showToast("Invalid item type selected."); return;
    }
    try {
        await addDoc(collectionRef, itemData);
        showToast(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} added successfully!`);
        adminAddForm.reset();
        linkInputs.forEach(input => input.value = '');
    } catch (error) {
        console.error("Error adding item:", error); showToast(`Failed to add ${itemType}. Please try again.`);
    }
});

// --- Admin Specific Functions ---
function loadAdminDataIfAdmin(user) {
    if (user.email === adminEmail) {
        adminPanelBtn.style.display = "block";
        displayAdminItems(collection(db, "tasks"), adminTasksContainer, "tasks");
        displayAdminItems(collection(db, "links"), adminLinksContainer, "links");
    } else {
        adminPanelBtn.style.display = "none";
    }
}

async function displayAdminItems(collectionRef, container, itemType) {
    container.innerHTML = '';
    const q = query(collectionRef, orderBy("createdAt", "desc"), limit(1000));
    const querySnapshot = await getDocs(q);
    querySnapshot.forEach(doc => {
        const item = doc.data();
        const itemDiv = document.createElement("div");
        itemDiv.classList.add(itemType === "tasks" ? "taskBox" : "linkBox");
        itemDiv.style.maxWidth = "300px"; itemDiv.style.flexGrow = "0";
        let reward;
        if (itemType === "tasks") {
            const taskCategory = getCategoryFromDescription(item.description);
            reward = item.reward || CATEGORY_EARNINGS[taskCategory] || TASK_EARNING_AMOUNT;
        } else {
            reward = item.reward || TASK_EARNING_AMOUNT;
        }
        let displayContent = `<p><strong>${item.description}</strong></p><p>Reward: ₹${reward.toFixed(2)}</p><p>Category: <strong>${item.category || getCategoryFromDescription(item.description)}</strong></p><small>Created: ${item.createdAt ? item.createdAt.toDate().toLocaleDateString() : 'N/A'}</small><br>`;
        if (itemType === "tasks") {
            displayContent += `<p>URL: <a href="${item.url}" target="_blank" style="color: #0ff; text-decoration: none;">${item.url}</a></p>`;
        } else if (itemType === "links" && item.urls && Array.isArray(item.urls)) {
            displayContent += `<p>Links:</p><ul>`;
            item.urls.forEach((url, index) => {
                displayContent += `<li><a href="${url}" target="_blank" style="color: #0ff; text-decoration: none;">Link ${index + 1}</a></li>`;
            });
            displayContent += `</ul>`;
        }
        itemDiv.innerHTML = displayContent;
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.style.cssText = "background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-top: 10px;";
        deleteButton.onclick = async () => {
            if (confirm(`Are you sure you want to delete this ${itemType.slice(0, -1)}?`)) {
                try {
                    await deleteDoc(doc.ref);
                    showToast(`${itemType.slice(0, -1)} deleted successfully.`);
                    itemDiv.remove();
                } catch (error) {
                    console.error("Error deleting item:", error); showToast("Failed to delete item.");
                }
            }
        };
        itemDiv.appendChild(deleteButton);
        container.appendChild(itemDiv);
    });
}

// --- Modal Content Definitions ---
const modalContent = {
    privacy: {
        title: "Privacy Policy (رازداری کی پالیسی)",
        text: `
            <h3>1. Introduction (تعارف)</h3>
            <p>Welcome to Free Earnings App. We are committed to protecting your privacy and handling your data in an open and transparent manner. This privacy policy sets out how we will collect, use, process, and disclose your information across the platform. By using our service, you agree to the collection and use of information in accordance with this policy.</p>
            <p>Yeh policy batati hai ke hum aapki maloomat (information) kaise jama karte, istemal karte, aur mehfooz rakhte hain. Is app ko istemal karke, aap is Privacy Policy se ittefaq karte hain.</p>
            
            <h3>2. Information We Collect (معلومات جو ہم جمع کرتے ہیں)</h3>
            <p>We collect various types of information to provide and improve our Service to you.</p>
            <ul>
                <li><strong>Personal Identification Information:</strong> When you register, we collect your name, email address, and password. For withdrawals, we may collect your payment details such as Easypaisa/JazzCash number or bank account information. This information is essential for creating and managing your account and processing payments.</li>
                <li><strong>Usage Data:</strong> We automatically collect information on how the Service is accessed and used. This may include your IP address, browser type, device type, pages visited, time spent on pages, and task completion data. This helps us understand user behavior and improve our platform.</li>
                <li><strong>Referral Information:</strong> If you were referred by another user, we store a connection to that user's account to manage referral commissions.</li>
            </ul>

            <h3>3. How We Use Your Information (آپ کی معلومات کا استعمال)</h3>
            <p>Your data is used for the following purposes:</p>
            <ul>
                <li><strong>To Provide and Maintain our Service:</strong> Your account details are used to log you in, display your balance, and manage your profile.</li>
                <li><strong>To Process Transactions:</strong> Your payment information is used exclusively for sending you your earnings.</li>
                <li><strong>To Communicate With You:</strong> We may use your email address to send you important updates, notifications about your account, or promotional information.</li>
                <li><strong>For Security and Fraud Prevention:</strong> We analyze usage data to detect and prevent fraudulent activities, such as the use of bots, VPNs, or multiple accounts, ensuring a fair platform for everyone.</li>
                <li><strong>To Improve Our Platform:</strong> By understanding how you use our app, we can identify areas for improvement and develop new features.</li>
            </ul>
            <p>Hum aapki maloomat kisi teesre fareeq (third party) ko farokht nahi karte hain. Sirf payment process karne ke liye zaroori maloomat payment provider ke sath share ki jaati hai.</p>

            <h3>4. Data Security (ڈیٹا کی حفاظت)</h3>
            <p>The security of your data is a top priority. We use a variety of industry-standard security technologies and procedures to help protect your personal information from unauthorized access, use, or disclosure. All data is transmitted over secure channels (HTTPS), and sensitive information like passwords is encrypted. However, no method of transmission over the Internet or method of electronic storage is 100% secure. While we strive to use commercially acceptable means to protect your Personal Information, we cannot guarantee its absolute security.</p>
            
            <h3>5. Your Rights (آپ کے حقوق)</h3>
            <p>You have certain rights regarding your personal data. You have the right to access, update, or delete the information we have on you. You can update your profile information directly within your account settings. If you wish to delete your account, please contact our support.</p>
        `
    },
    terms: {
        title: "Terms of Service (سروس کی شرائط)",
        text: `
            <p>Please read these Terms of Service ("Terms") carefully before using the Free Earnings App ("Service"). Your access to and use of the Service is conditioned on your acceptance of and compliance with these Terms. These Terms apply to all visitors, users, and others who access or use the Service.</p>
            
            <h3>1. Account Eligibility & Responsibilities (اکاؤنٹ کی اہلیت اور ذمہ داریاں)</h3>
            <ul>
                <li><strong>Eligibility:</strong> You must be at least 18 years old to use this service.</li>
                <li><strong>One Account Rule:</strong> Each user is strictly limited to one account per person, per household, and per IP address. Creating multiple accounts to abuse the system or referral program will result in the permanent ban of all associated accounts and forfeiture of all earnings.</li>
                <li><strong>Account Security:</strong> You are responsible for safeguarding the password that you use to access the Service and for any activities or actions under your password. We are not liable for any loss or damage arising from your failure to comply with this security obligation.</li>
            </ul>

            <h3>2. Prohibited Conduct (ممنوعہ سرگرمیاں)</h3>
            <p>Engaging in any of the following activities is strictly prohibited and will lead to immediate account termination without any payment:</p>
            <ul>
                <li><strong>Automation:</strong> Using any bots, scripts, spiders, or any other automated means to complete tasks or interact with the platform.</li>
                <li><strong>Fraudulent Activity:</strong> Falsifying task completion, using VPNs or proxies to hide your location, or any other method to deceive the system.</li>
                <li><strong>Multiple Accounts:</strong> As stated above, creating or using more than one account is strictly forbidden.</li>
                <li><strong>Exploiting Bugs:</strong> Abusing any vulnerability or bug in the system for personal gain.</li>
                <li><strong>Harassment:</strong> Abusing or harassing other users or the support staff.</li>
            </ul>
             <p><strong>Khulasa:</strong> Koi bhi gair qanooni, fraudulent, ya aisi sargarmi jis se system ko nuqsan ho, sakhti se mana hai. Is mein bots, scripts, VPN, ya multiple accounts ka istemal shamil hai. Aisa karne par aapka account foran block kar diya jayega aur aapki tamam earnings z-bat (forfeit) kar li jayengi.</p>

            <h3>3. Earnings, Withdrawals, and Payments (کمائی اور ادائیگی)</h3>
            <ul>
                <li><strong>Task Verification:</strong> All completed tasks are subject to verification. The decision of our verification team is final. Earnings will only be credited for tasks that are completed correctly and fully according to the provided instructions.</li>
                <li><strong>Payment Schedule:</strong> Withdrawals are processed during specific periods each month as mentioned in the withdrawal section. We reserve the right to change this schedule.</li>
                <li><strong>Minimum Withdrawal:</strong> A minimum balance is required to be eligible for a withdrawal. This amount is specified in the withdrawal section.</li>
                <li><strong>Forfeiture on Violation:</strong> If your account is terminated due to a violation of these Terms, you will lose all rights to any balance in your account.</li>
                <li><strong>Task Compliance is Mandatory:</strong> As stated in our withdrawal policy, failure to follow task instructions precisely will result in withdrawal rejection. This is a core condition of using our service.</li>
            </ul>

            <h3>4. Termination (اکاؤنٹ کی برطرفی)</h3>
            <p>We may terminate or suspend your account immediately, without prior notice or liability, for any reason whatsoever, including without limitation if you breach the Terms. Upon termination, your right to use the Service will immediately cease.</p>

            <h3>5. Limitation of Liability (ذمہ داری کی حد)</h3>
            <p>In no event shall Free Earnings App, nor its directors, employees, partners, or agents, be liable for any indirect, incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, or other intangible losses, resulting from your access to or use of or inability to access or use the Service.</p>
        `
    },
    about: {
        title: "About Us (ہمارے بارے میں)",
        text: `
            <h3>Our Mission (ہمارا مقصد)</h3>
            <p>At Free Earnings App, our mission is to create a reliable and accessible bridge between individuals seeking supplementary income and businesses looking for genuine online engagement. In a rapidly evolving digital world, we aim to empower people from all walks of life by providing them with a simple, secure, and transparent platform to monetize their free time. We believe in the dignity of work and strive to offer legitimate micro-earning opportunities that are fair and rewarding.</p>
            <p>Free Earnings App ka maqsad logon ko online extra income hasil karne ke liye ek aasan aur aitemad-mand (reliable) platform faraham karna hai. Hum is safar mein aapki madad karna chahte hain.</p>
            
            <h3>What We Do (ہم کیا کرتے ہیں؟)</h3>
            <p>We partner with businesses, marketers, and content creators who need to promote their products, services, and content online. We break down their requirements into simple, manageable digital tasks. Our users, from across the country, can then choose from a variety of these tasks, complete them according to clear instructions, and earn real money. Whether it's visiting a website, watching a video, engaging with a social media post, or testing an app, our platform provides a constant stream of opportunities.</p>
            
            <h3>Our Core Values (ہماری اقدار)</h3>
            <ul>
                <li><strong>Transparency (شفافیت):</strong> We believe in clear communication. All task rewards, withdrawal policies, and rules are clearly stated. There are no hidden fees or confusing terms. What you see is what you get.</li>
                <li><strong>Fairness (انصاف):</strong> We ensure that the rewards for tasks are fair and competitive. We have a robust verification system to ensure that every correctly completed task is rewarded, and we have strict anti-fraud measures to protect the integrity of the platform for our honest users.</li>
                <li><strong>Security (تحفظ):</strong> The security of your account and your data is paramount. We employ modern security practices to protect your information and ensure that your earnings are safe.</li>
                <li><strong>Empowerment (بااختیار بنانا):</strong> We are passionate about providing a tool that can help people achieve small financial goals, whether it's paying for a utility bill, saving up for something special, or simply having a bit of extra disposable income.</li>
            </ul>

            <h3>Our Vision for the Future (مستقبل کا وژن)</h3>
            <p>We are continuously working to enhance our platform, expand the variety of tasks available, and build a thriving community of earners. Our vision is to become the most trusted and user-friendly micro-tasking platform in the region, known for its reliability and commitment to its users.</p>
        `
    },
    taskDetails: {
        title: "Task Details & Earnings Guide (ٹاسک کی تفصیلات)",
        text: `
            <h3>The Golden Rules of Task Completion (ٹاسک مکمل کرنے کے سنہری اصول)</h3>
            <p>Your success on this platform depends entirely on your ability to follow instructions correctly. Cheating the system will only lead to account termination. Follow these golden rules to ensure you get paid for your hard work.</p>
            <ol>
                <li><strong>Read Every Instruction Carefully (ہر ہدایت کو غور سے پڑھیں):</strong> Before starting a task, read the description from start to finish. Do not assume you know what to do. Every task is different. The description is your contract; fulfilling it is how you earn.</li>
                <li><strong>Respect Timers and Delays (ٹائمر کا احترام کریں):</strong> If a task says "Wait for 30 seconds," you must wait for the full 30 seconds. Our system has mechanisms to verify this. Closing the page early will invalidate the task, and you will not be paid.</li>
                <li><strong>Perform the EXACT Action Required (صرف مطلوبہ کام کریں):</strong> If the task is to "Like the video," then only liking it is required. If it says "Like and Comment," you must do both. Do not do less than what is asked.</li>
                <li><strong>No Cheating (دھوکہ دہی نہیں):</strong> Do not use VPNs, proxies, ad-blockers that interfere with tasks, or any kind of automation (bots/scripts). Our system is designed to detect such activities. Attempting to cheat is the fastest way to get your account permanently banned and lose all your earnings.</li>
                <li><strong>Honesty is Key (ایمانداری کلید ہے):</strong> If a task asks for a screenshot or proof, provide genuine proof. Fabricated proof will be caught during withdrawal review and will lead to rejection and a potential ban.</li>
            </ol>

            <h3>Understanding the Verification Process (تصدیق کا عمل)</h3>
            <p>After you complete a task, it goes through a verification process:</p>
            <ul>
                <li><strong>Automated Checks:</strong> Our system performs initial checks, such as verifying visit duration, clicks, or if an action was registered.</li>
                <li><strong>Manual Review:</strong> For some tasks, and especially during a withdrawal request, our team may manually review your task history to ensure compliance. This is where we check for patterns of abuse or failure to follow instructions.</li>
                <li><strong>Why Tasks Get Rejected:</strong> A task can be rejected if you:
                    <ul>
                        <li>Did not wait for the full duration.</li>
                        <li>Did not perform all the required actions (e.g., forgot to comment).</li>
                        <li>Used a VPN or other forbidden tools.</li>
                        <li>The link was not working, and you did not report it (if applicable).</li>
                    </ul>
                </li>
            </ul>
             <p><strong>یاد رکھیں:</strong> آپ کی کمائی کا انحصار آپ کی ایمانداری اور ہدایات پر عمل کرنے پر ہے۔</p>
        `
    },
    withdrawalProfile: {
        title: "Withdrawal Profile & Rules (پیسے نکالنے کے اصول)",
        text: `
            <h3>1. The Importance of Accuracy (درست معلومات کی اہمیت)</h3>
            <p>Your Withdrawal Profile is the most critical part of getting paid. Providing 100% accurate information is your responsibility. Any error in your payment details can lead to significant delays or even the permanent loss of your funds. Double-check every digit and every letter before submitting a withdrawal request.</p>
            <p>Withdrawal request karte waqt, apna account number, account title (naam), aur mobile number bilkul sahi likhein. Ek choti si ghalti se aapki payment ghalat jagah ja sakti hai ya ruk sakti hai. Ghalat maloomat faraham karne ki soorat mein, hum payment ke nuqsan ke zimmedar nahi honge.</p>
            
            <h3>2. The Withdrawal Process Flow (پیسے نکالنے کا مکمل عمل)</h3>
            <p>When you request a withdrawal, it goes through several stages:</p>
            <ol>
                <li><strong>Request Submitted (درخواست جمع ہوگئی):</strong> You submit a request from the withdrawal page. The amount is deducted from your wallet and is now locked for processing.</li>
                <li><strong>Pending Review (جائزے کے لیے زیر التوا):</strong> Your request enters a queue. During this stage, our team has not yet started reviewing it.</li>
                <li><strong>In-Depth Review & Processing (تفصیلی جائزہ):</strong> This is the most important stage. Our team performs a rigorous audit of your account, which includes:
                    <ul>
                        <li><strong>Task Compliance Check:</strong> We manually and automatically review your recent task history. We check if you have followed all instructions, respected timers, and completed tasks honestly. <strong>This is the number one reason for rejection. Any evidence of cutting corners or violating task rules will result in immediate rejection.</strong></li>
                        <li><strong>Fraud Check:</strong> We check your account for any signs of prohibited activities, such as multiple accounts from the same IP, VPN usage, or bot-like activity.</li>
                        <li><strong>Payment Detail Verification:</strong> We ensure your provided payment details are in the correct format.</li>
                    </ul>
                </li>
                <li><strong>Approved / Rejected (منظور / مسترد):</strong> Based on the review, your request is either approved or rejected.
                    <ul>
                        <li><strong>Approved:</strong> If approved, the funds are sent to your specified account. Please allow 24-72 business hours for the funds to reflect.</li>
                        <li><strong>Rejected:</strong> If rejected, the funds are returned to your app wallet (unless the rejection was due to severe fraud, in which case the account is banned). You will see the "Rejected" status in your history.</li>
                    </ul>
                </li>
            </ol>

            <h3>3. Common Reasons for Withdrawal Rejection (مسترد ہونے کی عام وجوہات)</h3>
            <ul>
                <li><strong>FAILURE TO FOLLOW TASK INSTRUCTIONS: This is the most common reason.</strong></li>
                <li>Providing incorrect payment details (wrong account number, name mismatch).</li>
                <li>Suspicion of using bots, VPNs, or multiple accounts.</li>
                <li>Not meeting the minimum withdrawal threshold.</li>
                <li>Requesting withdrawal before any mandatory holding period is over.</li>
            </ul>
            <p><strong>Final Decision:</strong> The decision made by our review team regarding any withdrawal request is final and not subject to appeal, especially in cases of clear violation of our terms and task rules.</p>
        `
    }
};

function openModal(type) {
    modalTitle.innerText = modalContent[type].title;
    modalText.innerHTML = modalContent[type].text;
    modal.style.display = "block";
}

privacyBtn.onclick = () => openModal('privacy');
termsBtn.onclick = () => openModal('terms');
aboutBtn.onclick = () => openModal('about');
taskDetailsBtn.onclick = () => openModal('taskDetails');
withdrawalProfileBtn.onclick = () => openModal('withdrawalProfile');

contactEmailLink.addEventListener("click", () => {
    const userEmail = auth.currentUser ? auth.currentUser.email : 'N/A';
    const subject = "Inquiry from Free Earnings App User";
    const body = `Hello,\n\nMy Email: ${userEmail}\n\nMy Inquiry:\n`;
    window.location.href = `mailto:${adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
});

contactWhatsappLink.addEventListener("click", () => {
    const userEmail = auth.currentUser ? auth.currentUser.email : 'N/A';
    const prefillText = `Hello, I'm contacting you from the Free Earnings App. My Email: ${userEmail}.`;
    window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(prefillText)}`, "_blank");
});

closeBtn.onclick = () => { modal.style.display = "none"; };
priceSelectionModalCloseBtn.onclick = () => {
    priceSelectionModal.style.display = "none";
    confirmPriceSelectionBtn.disabled = true;
    confirmPriceSelectionBtn.dataset.selectedPrice = '';
    confirmPriceSelectionBtn.dataset.selectedCategory = '';
    priceOptionsContainer.querySelectorAll('.price-option').forEach(div => {
        div.style.backgroundColor = '#222'; div.style.borderColor = '#333';
    });
};

window.onclick = (event) => {
    if (event.target == modal) modal.style.display = "none";
    if (event.target == priceSelectionModal) {
        priceSelectionModal.style.display = "none";
        confirmPriceSelectionBtn.disabled = true;
        confirmPriceSelectionBtn.dataset.selectedPrice = '';
        confirmPriceSelectionBtn.dataset.selectedCategory = '';
        priceOptionsContainer.querySelectorAll('.price-option').forEach(div => {
            div.style.backgroundColor = '#222'; div.style.borderColor = '#333';
        });
    }
};

document.querySelectorAll("nav button[data-section]").forEach(button => {
    button.addEventListener("click", () => {
        const sectionId = button.dataset.section;
        if (sectionId) {
            showSection(sectionId);
            if (sectionId === 'forYouPage' && auth.currentUser) {
                loadForYouContent(auth.currentUser.uid);
            }
        }
    });
});

taskCategoryFilters.addEventListener("click", (e) => {
    if (e.target.tagName === 'BUTTON') {
        document.querySelectorAll("#taskCategoryFilters button").forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        filterTasks();
    }
});

// --- EARNINGS MANAGEMENT FUNCTIONS (with Referral Logic) ---
async function addEarning(userId, category, amount) {
    if (!userId || !category || amount === undefined || isNaN(amount) || amount <= 0) {
        console.error("Invalid input for addEarning:", { userId, category, amount });
        showToast("Error adding earning: Invalid data provided.");
        return;
    }
    const userRef = doc(db, "users", userId);
    try {
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
            console.error(`Earning update failed: User document ${userId} not found.`);
            showToast("Error: User profile not found. Please contact support.");
            return;
        }
        const userData = userSnap.data();
        const currentWallet = userData.wallet || 0;
        const currentEarningsHistory = userData.earningsHistory || {};
        currentEarningsHistory[category] = (currentEarningsHistory[category] || 0) + amount;
        
        const batch = writeBatch(db);
        batch.update(userRef, {
            wallet: currentWallet + amount,
            earningsHistory: currentEarningsHistory
        });

        // Referral Commission Logic
        if (userData.referredBy) {
            const referrerId = userData.referredBy;
            const referralCommission = amount * REFERRAL_COMMISSION_RATE;
            const referrerRef = doc(db, "users", referrerId);
            const referrerSnap = await getDoc(referrerRef);
            if (referrerSnap.exists()) {
                const referrerData = referrerSnap.data();
                const newReferrerWallet = (referrerData.wallet || 0) + referralCommission;
                const newTotalReferralEarnings = (referrerData.totalReferralEarnings || 0) + referralCommission;
                batch.update(referrerRef, {
                    wallet: newReferrerWallet,
                    totalReferralEarnings: newTotalReferralEarnings
                });
                console.log(`Referral commission of ₹${referralCommission.toFixed(4)} awarded to user ${referrerId}`);
            }
        }
        await batch.commit();
        console.log(`Earning added: User ${userId}, Category ${category}, Amount ${amount}`);
    } catch (error) {
        console.error(`Error adding earning for user ${userId}:`, error);
        showToast(`Failed to add earning: ${error.message}.`);
    }
}
</script>

</body>
</html>
