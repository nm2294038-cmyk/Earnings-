<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer Coins</title>
    
    <!-- Firebase SDKs (Version 8.10.0) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- VARIABLES --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --dark-bg: #2c3e50;
            --light-bg: #ffffff;
            --danger-color: #dc3545;
            --accent-color: #ff9800;
            --shadow-deep: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* --- BASE STYLES (Desktop Default) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        header {
            background-color: var(--dark-bg);
            color: white;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.5em;
            margin: 0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #profileIconButton {
            background: none;
            border: 2px solid white;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            transition: background-color 0.3s;
        }

        #currentBalanceDisplay {
            background-color: var(--accent-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
            display: none;
        }

        .container {
            width: 90%;
            max-width: 800px;
            margin: 40px auto;
            background-color: var(--light-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-deep);
        }

        /* --- GUIDE ARTICLE STYLES --- */
        #guideArticle {
            display: none;
            padding: 10px;
        }
        #guideArticle h2 {
            color: var(--primary-color);
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .call-to-action {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- TRANSFER SECTION STYLING --- */
        #transferSection {
            display: none;
        }

        .transfer-box {
            padding: 20px;
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            background-color: #f0f8ff;
            margin-bottom: 30px;
        }
        
        /* Coin Buttons Container (Desktop: Flexible row) */
        .coin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .coin-buttons button {
            background-color: #e0e0e0;
            color: #333;
            border: 1px solid #ccc;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            flex-grow: 1;
            min-width: 100px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 1em;
        }
        
        #sendButton {
            padding: 15px 20px;
            font-size: 1.2em;
        }

        /* --- HISTORY STYLING --- */
        .history-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #ccc;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th, .history-table td {
            padding: 10px;
            font-size: 0.9em;
        }
        .sent { color: var(--danger-color); font-weight: bold; }
        .received { color: var(--secondary-color); font-weight: bold; }

        /* --- AUTH MODAL STYLING (Remains standard) --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--light-bg); padding: 40px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: var(--shadow-deep); position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 30px; font-weight: bold; cursor: pointer; }
        .auth-form input { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; padding: 10px; width: 100%; box-sizing: border-box; }
        .auth-form button { background-color: var(--primary-color); color: white; padding: 10px; border: none; border-radius: 4px; width: 100%; cursor: pointer; }
        .auth-toggle { margin-top: 20px; text-align: center; }
        .auth-toggle a { font-weight: bold; color: var(--primary-color); cursor: pointer; }

        /* ========================================= */
        /* --- TABLET STYLES (Max 768px) --- */
        /* ========================================= */
        @media (max-width: 768px) {
            .container {
                margin: 20px auto;
                padding: 20px;
            }
            header h1 {
                font-size: 1.4em;
            }
            .coin-buttons button {
                padding: 8px 10px;
                font-size: 0.9em;
            }
        }

        /* ========================================= */
        /* --- MOBILE STYLES (Max 480px) --- */
        /* ========================================= */
        @media (max-width: 480px) {
            header {
                padding: 10px 15px;
            }
            header h1 {
                font-size: 1.2em;
            }
            
            #currentBalanceDisplay {
                font-size: 0.9em;
                padding: 6px 10px;
            }

            .container {
                padding: 15px;
            }
            
            /* Coin Buttons (3 columns) */
            .coin-buttons {
                gap: 5px;
                justify-content: space-between;
            }
            .coin-buttons button {
                width: 30%; /* Approx 3 columns */
                flex-grow: 0;
                padding: 6px 4px;
                font-size: 0.75em;
                min-width: 0;
            }

            .history-table th, .history-table td {
                padding: 6px;
                font-size: 0.8em;
            }
            
            /* Hide unnecessary columns on small screens */
            .history-table th:nth-child(4),
            .history-table td:nth-child(4) {
                display: none; /* Hide Date column */
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>Coins Transfer Center</h1>
        <div class="header-right">
            <div id="currentBalanceDisplay" class="wallet-display">
                0 Coins
            </div>
            <button id="profileIconButton" title="Login or Sign Up">üë§</button>
        </div>
    </header>

    <div class="container">
        
        <!-- GUIDE ARTICLE (Logged Out View) -->
        <div id="guideArticle">
            <h2>Coins Transfer Karne Ki Mukammal Guide</h2>
            <p>Coins Transfer Center mein aapka khushamdeed! Yeh section aapko fori taur par apne Coins kisi doosre registered user ke wallet mein bhejney ki ijazat deta hai. Yeh amal 100% secure aur real-time hai.</p>
            
            <ol>
                <li><strong>Login/Signup Karen:</strong> Sabse pehle, upar **Profile Icon (üë§)** par click karke login ya signup karen.</li>
                <li><strong>Balance Check Karen:</strong> Login ke baad, aapka maujooda balance header mein show hoga. **Aap sirf wohi coins bhej sakte hain jo aapke wallet mein maujood hain.**</li>
                <li><strong>Receiver Email Darj Karen:</strong> Jis user ko coins bhejney hain, unka registered email address sahi se darj karen. System fori taur par us user ka naam verify karega.</li>
                <li><strong>Miqdar (Amount) Chunein:</strong> Coins ki woh miqdar darj karen jo aap transfer karna chahte hain.</li>
                <li><strong>Real-time Transfer:</strong> Transaction submit karte hi, coins aapke wallet se deduct hokar fori taur par receiver ke wallet mein jama ho jayenge.</li>
            </ol>
            
            <div class="call-to-action" onclick="document.getElementById('profileIconButton').click()">
                Coins Bhejne Ke Liye Profile Icon (üë§) Par Click Karen
            </div>
            
            <p style="text-align: center; margin-top: 20px;">
                <a href="index.html" style="color: var(--primary-color);">‚Üê Wapas Dashboard Par Jaen</a>
            </p>
        </div>

        <!-- TRANSFER SECTION (Logged In View) -->
        <div id="transferSection">
            <div class="transfer-box">
                <h2>Coins Bhejein</h2>
                <p style="text-align: center; color: var(--danger-color);">Send Coins Another Users</p>

                <form id="transferForm">
                    
                    <!-- COIN BUTTONS -->
                    <div class="coin-buttons" id="coinButtonsContainer">
                        <!-- Buttons will be generated by JavaScript -->
                    </div>
                    
                    <div class="form-group">
                        <label for="transferAmount">Coins Ki Miqdar</label>
                        <input type="number" id="transferAmount" placeholder="Minimum 1 Coin" required min="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="recipientEmail">Receiver Ki Email Address</label>
                        <input type="email" id="recipientEmail" placeholder="Receiver ka email yahan darj karen" required>
                    </div>

                    <div id="recipientInfo">
                        Receiver Ka Naam: <strong id="recipientNameDisplay">Loading...</strong>
                    </div>

                    <button type="submit" id="sendButton" disabled>Coins Transfer Karen</button>
                </form>
            </div>
            
            <!-- TRANSFER HISTORY SECTION -->
            <div class="history-section">
                <h3>Transfer History</h3>
                <div id="transferHistoryList">
                    <p>History load ho rahi hai...</p>
                </div>
            </div>
            
            <p style="text-align: center; margin-top: 20px;">
                <a href="index.html" style="color: var(--primary-color);">‚Üê Wapas Dashboard Par Jaen</a>
            </p>
        </div>
    </div>
    
    <!-- AUTH MODAL (Login/Signup) -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('authModal').style.display='none'">&times;</span>
            <h3 id="authTitle">Login Karen</h3>
            
            <form class="auth-form" id="authForm">
                <input type="email" id="authEmail" placeholder="Email Address" required>
                <input type="password" id="authPassword" placeholder="Password" required>
                <button type="submit" id="authButton">Login</button>
            </form>
            
            <div class="auth-toggle">
                <!-- Redirect to index.html for full signup process -->
                <p id="toggleText">Account nahi hai? <a onclick="window.location.href='index.html'">Signup Karen</a></p>
                <button id="logoutButton" style="display: none; background-color: #dc3545; margin-top: 15px;">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION AND INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNYv9SNUjMAHlaPzfovyYefoBNDgx4Gd4",
            authDomain: "traffic-exchange-62a58.firebaseapp.com",
            projectId: "traffic-exchange-62a58",
            storageBucket: "traffic-exchange-62a58.appspot.com",
            messagingSenderId: "474999317287",
            appId: "1:474999317287:web:8e28a2f5f1a959d8ce3f02",
            measurementId: "G-HJQ46RQNZS"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- CONSTANTS ---
        const TRANSFER_AMOUNTS = [100, 1200, 2400, 3600, 4800, 5800, 7800, 15000, 25000, 35000];

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentCoinBalance = 0;
        let recipientUserId = null;

        // --- DOM ELEMENTS ---
        const currentBalanceDisplay = document.getElementById('currentBalanceDisplay');
        const guideArticle = document.getElementById('guideArticle');
        const transferSection = document.getElementById('transferSection');
        const transferForm = document.getElementById('transferForm');
        const recipientEmailInput = document.getElementById('recipientEmail');
        const recipientInfoDiv = document.getElementById('recipientInfo');
        const recipientNameDisplay = document.getElementById('recipientNameDisplay');
        const transferAmountInput = document.getElementById('transferAmount');
        const sendButton = document.getElementById('sendButton');
        const profileIconButton = document.getElementById('profileIconButton');
        const authModal = document.getElementById('authModal');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const logoutButton = document.getElementById('logoutButton');
        const transferHistoryList = document.getElementById('transferHistoryList');
        const coinButtonsContainer = document.getElementById('coinButtonsContainer');


        // --- INITIAL SETUP: RENDER COIN BUTTONS ---
        function renderCoinButtons() {
            coinButtonsContainer.innerHTML = '';
            TRANSFER_AMOUNTS.forEach(amount => {
                const button = document.createElement('button');
                button.setAttribute('type', 'button');
                button.textContent = `${amount.toLocaleString()} Coins`;
                button.setAttribute('data-amount', amount);
                button.addEventListener('click', () => {
                    transferAmountInput.value = amount;
                    transferAmountInput.dispatchEvent(new Event('input')); 
                });
                coinButtonsContainer.appendChild(button);
            });
        }
        renderCoinButtons();


        // --- AUTH MODAL LOGIC ---
        function toggleAuthMode() {
            authTitle.textContent = "Login Karen";
            authButton.textContent = "Login";
            document.getElementById('authForm').reset();
        }

        profileIconButton.addEventListener('click', () => {
            if (currentUser) {
                if (confirm("Aap pehle se logged in hain. Kya aap logout karna chahte hain?")) {
                    auth.signOut();
                }
            } else {
                authModal.style.display = 'flex';
                toggleAuthMode();
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                authModal.style.display = 'none';
            } catch (error) {
                alert(`Login Failed: ${error.message}`);
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            await auth.signOut();
        });


        // --- WALLET LISTENER ---
        function listenToWallet(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    currentCoinBalance = Number(data.coins) || 0;
                    currentBalanceDisplay.textContent = `${currentCoinBalance.toLocaleString()} Coins`;
                } else {
                    currentCoinBalance = 0;
                    currentBalanceDisplay.textContent = `0 Coins`;
                }
                checkFormValidity();
            });
        }
        
        // --- AUTH CHECK & VIEW MANAGEMENT ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // Logged In: Show Transfer Section
                guideArticle.style.display = 'none';
                transferSection.style.display = 'block';
                currentBalanceDisplay.style.display = 'block';
                
                listenToWallet(user.uid);
                listenToTransferHistory(user.uid, user.email);
            } else {
                // Logged Out: Show Guide Article
                guideArticle.style.display = 'block';
                transferSection.style.display = 'none';
                currentBalanceDisplay.style.display = 'none';
                currentCoinBalance = 0;
            }
        });

        // --- RECIPIENT VALIDATION (Real-time check on email input) ---
        let emailCheckTimeout;

        recipientEmailInput.addEventListener('input', () => {
            clearTimeout(emailCheckTimeout);
            recipientInfoDiv.style.display = 'none';
            recipientNameDisplay.textContent = 'Loading...';
            recipientUserId = null;
            checkFormValidity();

            const email = recipientEmailInput.value.trim();
            if (email.length < 5 || !email.includes('@')) return;

            emailCheckTimeout = setTimeout(() => {
                validateRecipient(email);
            }, 1000);
        });

        async function validateRecipient(email) {
            if (currentUser && currentUser.email.toLowerCase() === email.toLowerCase()) {
                recipientInfoDiv.style.display = 'block';
                recipientNameDisplay.textContent = 'Aap khud ko coins nahi bhej sakte!';
                recipientInfoDiv.style.backgroundColor = '#ffcccc';
                recipientUserId = null;
                checkFormValidity();
                return;
            }

            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('email', '==', email).limit(1).get();

                if (!snapshot.empty) {
                    const recipientDoc = snapshot.docs[0];
                    const recipientData = recipientDoc.data();
                    
                    recipientUserId = recipientDoc.id;
                    recipientNameDisplay.textContent = recipientData.name || recipientData.email;
                    recipientInfoDiv.style.display = 'block';
                    recipientInfoDiv.style.backgroundColor = '#e6ffe6';
                } else {
                    recipientNameDisplay.textContent = 'Yeh email address registered nahi hai.';
                    recipientInfoDiv.style.display = 'block';
                    recipientInfoDiv.style.backgroundColor = '#ffcccc';
                    recipientUserId = null;
                }
            } catch (error) {
                console.error("Recipient validation failed:", error);
                recipientNameDisplay.textContent = 'Verification mein masla hua.';
                recipientInfoDiv.style.display = 'block';
                recipientInfoDiv.style.backgroundColor = '#ffcccc';
                recipientUserId = null;
            }
            checkFormValidity();
        }

        transferAmountInput.addEventListener('input', checkFormValidity);

        function checkFormValidity() {
            const amount = Number(transferAmountInput.value);
            const isRecipientValid = recipientUserId && amount > 0;
            const isBalanceSufficient = amount <= currentCoinBalance;

            if (isRecipientValid && isBalanceSufficient) {
                sendButton.disabled = false;
                sendButton.textContent = `Transfer ${amount.toLocaleString()} Coins`;
            } else {
                sendButton.disabled = true;
                if (amount > currentCoinBalance) {
                    sendButton.textContent = `Balance Kam Hai (${currentCoinBalance.toLocaleString()} Available)`;
                } else if (amount <= 0) {
                    sendButton.textContent = `Miqdar Darj Karen`;
                } else if (!recipientUserId) {
                    sendButton.textContent = `Receiver Verify Karen`;
                } else {
                    sendButton.textContent = `Coins Transfer Karen`;
                }
            }
        }

        // --- TRANSFER TRANSACTION LOGIC ---

        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = Number(transferAmountInput.value);
            const senderUid = currentUser.uid;
            const receiverUid = recipientUserId;
            
            if (!receiverUid || amount <= 0 || amount > currentCoinBalance) {
                alert("Transaction ke liye data sahi nahi hai ya balance kam hai.");
                return;
            }

            if (!confirm(`Kya aap waqai ${amount.toLocaleString()} Coins ${recipientNameDisplay.textContent} ko transfer karna chahte hain?`)) {
                return;
            }

            sendButton.disabled = true;
            sendButton.textContent = 'Transferring...';

            const senderRef = db.collection('users').doc(senderUid);
            const receiverRef = db.collection('users').doc(receiverUid);

            try {
                await db.runTransaction(async (transaction) => {
                    const senderDoc = await transaction.get(senderRef);
                    const receiverDoc = await transaction.get(receiverRef);

                    if (!senderDoc.exists || !receiverDoc.exists) {
                        throw new Error("Sender ya Receiver ka account nahi mila.");
                    }

                    const senderCoins = senderDoc.data().coins || 0;
                    
                    if (senderCoins < amount) {
                        throw new Error("Insufficient Balance (Coins).");
                    }

                    // 1. Deduct from Sender
                    transaction.update(senderRef, {
                        coins: firebase.firestore.FieldValue.increment(-amount)
                    });

                    // 2. Add to Receiver
                    transaction.update(receiverRef, {
                        coins: firebase.firestore.FieldValue.increment(amount)
                    });
                    
                    // 3. Log the transaction 
                    db.collection('transfers').add({
                        senderId: senderUid,
                        receiverId: receiverUid,
                        senderEmail: currentUser.email,
                        receiverEmail: recipientEmailInput.value.trim(),
                        amount: amount,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                alert(`Transfer Successful! ${amount.toLocaleString()} Coins ${recipientNameDisplay.textContent} ko bhej diye gaye.`);
                transferForm.reset();
                recipientInfoDiv.style.display = 'none';
                recipientUserId = null;
                checkFormValidity();

            } catch (error) {
                console.error("Transaction failed:", error);
                alert(`Transfer failed: ${error.message}`);
                checkFormValidity();
            }
        });
        
        // --- HISTORY LOGIC ---
        
        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleDateString('en-PK', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            }
            return 'N/A';
        }

        function renderTransferHistory(combinedHistory, userEmail) {
            if (combinedHistory.length === 0) {
                transferHistoryList.innerHTML = '<p>Abhi tak koi transfer record maujood nahi hai.</p>';
                return;
            }

            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Coins</th>
                            <th>Sender/Receiver</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            combinedHistory.forEach(t => {
                const isSent = t.senderEmail === userEmail;
                const typeClass = isSent ? 'sent' : 'received';
                const typeText = isSent ? 'SENT (-)' : 'RECEIVED (+)';
                const relatedUser = isSent ? t.receiverEmail : t.senderEmail;
                
                html += `
                    <tr>
                        <td><span class="${typeClass}">${typeText}</span></td>
                        <td>${t.amount.toLocaleString()}</td>
                        <td>${relatedUser}</td>
                        <td>${formatTimestamp(t.timestamp)}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            transferHistoryList.innerHTML = html;
        }


        function listenToTransferHistory(uid, email) {
            // NOTE: Requires Composite Indexes in Firestore:
            // 1. (senderId Ascending, timestamp Descending)
            // 2. (receiverId Ascending, timestamp Descending)
            
            const sentQuery = db.collection('transfers')
                .where('senderId', '==', uid)
                .orderBy('timestamp', 'desc')
                .limit(10);
            
            const receivedQuery = db.collection('transfers')
                .where('receiverId', '==', uid)
                .orderBy('timestamp', 'desc')
                .limit(10);

            let sentTransfers = [];
            let receivedTransfers = [];
            let loadedCount = 0;

            const processHistory = () => {
                // Combine and sort all transactions
                const combinedHistory = [...sentTransfers, ...receivedTransfers].sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA; // Sort descending by time
                });
                renderTransferHistory(combinedHistory, email);
            };

            const updateHistory = () => {
                loadedCount++;
                if (loadedCount === 2) {
                    processHistory();
                }
            };

            // Listener for Sent Transfers
            sentQuery.onSnapshot(snapshot => {
                sentTransfers = snapshot.docs.map(doc => doc.data());
                updateHistory();
            }, error => {
                console.error("Error fetching sent history:", error);
                transferHistoryList.innerHTML = '<p style="color: var(--danger-color);">History Load Error. (Check Firestore Index 1)</p>';
                updateHistory(); 
            });

            // Listener for Received Transfers
            receivedQuery.onSnapshot(snapshot => {
                receivedTransfers = snapshot.docs.map(doc => doc.data());
                updateHistory();
            }, error => {
                console.error("Error fetching received history:", error);
                transferHistoryList.innerHTML = '<p style="color: var(--danger-color);">History Load Error. (Check Firestore Index 2)</p>';
                updateHistory(); 
            });
        }
        
    </script>
</body>
</html>
